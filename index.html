<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="A complete Bookshop Management Web App with IndexedDB for offline use. Manage books, customers, sales, suppliers, purchase orders, reports, and expenses.">
    <meta name="keywords"
        content="Bookshop, Management, Web App, IndexedDB, Offline, Books, Customers, Sales, Reports, Inventory, Suppliers, Purchase Orders, Expenses, Promotions, Analytics">
    <meta name="author" content="Yasin Ullah, Pakistan">
    <title>Bookshop Management</title>
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%232a9d8f' d='M18 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2m-1 15H7V5h10v12M9 7h6v2H9V7m0 4h6v2H9v-2m0 4h6v2H9v-2z'/%3E%3C/svg%3E"
        type="image/svg+xml">
    <style>
        :root {
            --primary-color: #2a9d8f;
            --primary-dark-color: #218579;
            --accent-color: #f4a261;
            --background-color: #f5f7fa;
            --surface-color: #ffffff;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #e76f51;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --disabled-color: #cccccc;
        }

        [data-theme='dark'] {
            --primary-color: #55b7a8;
            --primary-dark-color: #4a9d91;
            --accent-color: #f4a261;
            --background-color: #2c3e50;
            --surface-color: #34495e;
            --text-color: #ecf0f1;
            --light-text-color: #bdc3c7;
            --border-color: #4a657e;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --danger-color: #e76f51;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --disabled-color: #555555;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        #app-container {
            display: flex;
            flex: 1;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            background-color: var(--background-color);
            box-shadow: var(--shadow-color) 0 0 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        aside.sidebar {
            width: 250px;
            background-color: var(--surface-color);
            padding: 20px;
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        aside.sidebar h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        aside.sidebar nav ul {
            list-style: none;
            flex-grow: 1;
        }

        aside.sidebar nav ul li {
            margin-bottom: 10px;
        }

        aside.sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--light-text-color);
            text-decoration: none;
            border-radius: 6px;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
        }

        aside.sidebar nav ul li a:hover,
        aside.sidebar nav ul li a.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        aside.sidebar nav ul li a.active {
            font-weight: 600;
        }

        aside.sidebar nav ul li a i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .dark-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
            padding: 10px 15px;
            background-color: var(--background-color);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .dark-mode-toggle label {
            font-weight: 500;
            color: var(--text-color);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        main.content {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--background-color);
            overflow-y: auto;
        }

        .page-content:not(.active) {
            display: none;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-header h1 {
            font-size: 2em;
            color: var(--primary-color);
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .btn-secondary {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--background-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #d15034;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #117a8b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .card {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .card-header {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            text-align: center;
            padding: 25px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-card h3 {
            font-size: 1.2em;
            color: var(--light-text-color);
            margin-bottom: 10px;
        }

        .dashboard-card p {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .dashboard-card p.danger {
            color: var(--danger-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .data-table thead {
            background-color: var(--primary-color);
            color: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--background-color);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table .actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .data-table .actions .btn {
            padding: 6px 10px;
            font-size: 0.85em;
        }

        .low-stock {
            background-color: #ffe0b2 !important;
            color: #ff6f00 !important;
        }

        [data-theme='dark'] .low-stock {
            background-color: #6a4000 !important;
            color: #ffd180 !important;
        }

        .inactive-customer {
            background-color: #fce8e6 !important;
            color: var(--danger-color) !important;
        }

        [data-theme='dark'] .inactive-customer {
            background-color: #5c3029 !important;
            color: #ff998c !important;
        }


        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="url"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="date"],
        .form-group input[type="month"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px var(--shadow-color);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--light-text-color);
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--text-color);
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-left: 5px solid var(--success-color);
        }

        .toast.error {
            border-left: 5px solid var(--danger-color);
        }

        .toast.info {
            border-left: 5px solid var(--info-color);
        }

        .toast.warning {
            border-left: 5px solid var(--warning-color);
        }

        .toast i {
            font-size: 1.2em;
        }

        .search-sort-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-sort-controls .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 0;
        }

        .search-sort-controls .form-group label {
            display: none;
        }

        .search-sort-controls .form-group input,
        .search-sort-controls .form-group select {
            width: 100%;
        }

        #cart-items-table .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #cart-items-table .quantity-controls input {
            width: 60px;
            text-align: center;
            padding: 5px;
        }

        #cart-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            font-weight: 600;
        }

        #cart-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-filters .form-group {
            flex: 1;
            min-width: 150px;
        }

        .report-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .flex-group {
            display: flex;
            gap: 15px;
        }

        .flex-group .form-group {
            flex: 1;
        }

        .img-preview {
            width: 100px;
            height: 100px;
            border: 1px dashed var(--border-color);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: var(--background-color);
            margin-top: 10px;
        }

        .img-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background-color: var(--primary-dark-color);
        }

        .pagination button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        .pagination span {
            font-weight: 500;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            position: relative;
        }

        .promotion-type-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .promotion-type-toggle button {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--background-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .promotion-type-toggle button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .item-picker {
            position: relative;
        }

        .item-picker-results {
            position: absolute;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 10;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .item-picker-results div {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .item-picker-results div:hover {
            background-color: var(--background-color);
        }

        @media (max-width: 992px) {
            aside.sidebar {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            #app-container {
                flex-direction: column;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }

            aside.sidebar {
                width: 100%;
                height: auto;
                padding: 15px 20px;
                box-shadow: 0 2px 5px var(--shadow-color);
                border-bottom: 1px solid var(--border-color);
                border-right: none;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            aside.sidebar h2 {
                margin-bottom: 0;
                border-bottom: none;
                padding-bottom: 0;
                font-size: 1.5em;
            }

            aside.sidebar nav {
                display: none;
            }

            aside.sidebar .dark-mode-toggle {
                margin-top: 0;
            }

            .hamburger-menu {
                display: block !important;
                background: none;
                border: none;
                color: var(--primary-color);
                font-size: 1.8em;
                cursor: pointer;
            }

            aside.sidebar.active {
                flex-direction: column;
                align-items: flex-start;
            }

            aside.sidebar.active nav {
                display: block;
                width: 100%;
                margin-top: 20px;
            }

            aside.sidebar.active nav ul {
                flex-direction: column;
            }

            aside.sidebar.active nav ul li {
                margin: 0;
            }

            aside.sidebar.active nav ul li a {
                padding: 15px 20px;
                border-radius: 0;
            }

            main.content {
                padding: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .page-header h1 {
                font-size: 1.8em;
            }

            .search-sort-controls,
            .report-filters,
            .flex-group {
                flex-direction: column;
                gap: 10px;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }

            .data-table .actions {
                flex-direction: column;
                gap: 2px;
            }

            .data-table .actions .btn {
                width: 100%;
                text-align: center;
            }

            .hamburger-menu {
                order: -1;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                padding: 20px;
            }
        }

        .hamburger-menu {
            display: none;
        }

        /* Font Awesome for Icons */
        @import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css");
    </style>
</head>

<body>
    <div id="app-container">
        <aside class="sidebar">
            <button class="hamburger-menu" id="hamburger-menu"><i class="fas fa-bars"></i></button>
            <h2>Bookshop Manager</h2>
            <nav>
                <ul>
                    <li><a href="#dashboard" class="nav-link active"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#books" class="nav-link"><i class="fas fa-book"></i> Books</a></li>
                    <li><a href="#customers" class="nav-link"><i class="fas fa-users"></i> Customers</a></li>
                    <li><a href="#suppliers" class="nav-link"><i class="fas fa-truck-moving"></i> Suppliers</a></li>
                    <li><a href="#purchase-orders" class="nav-link"><i class="fas fa-boxes"></i> Purchase Orders</a>
                    </li>
                    <li><a href="#cart" class="nav-link"><i class="fas fa-shopping-cart"></i> Cart & Sales</a></li>
                    <li><a href="#promotions" class="nav-link"><i class="fas fa-tag"></i> Promotions</a></li>
                    <li><a href="#expenses" class="nav-link"><i class="fas fa-money-bill-wave"></i> Expenses</a></li>
                    <li><a href="#reports" class="nav-link"><i class="fas fa-chart-line"></i> Reports</a></li>
                    <li><a href="#backup-restore" class="nav-link"><i class="fas fa-database"></i> Backup/Restore</a>
                    </li>
                </ul>
            </nav>
            <div class="dark-mode-toggle">
                <label for="dark-mode-switch">Dark Mode</label>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-switch">
                    <span class="slider"></span>
                </label>
            </div>
        </aside>

        <main class="content">
            <section id="dashboard" class="page-content active">
                <div class="page-header">
                    <h1>Dashboard</h1>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Total Books</h3>
                        <p id="total-books-count">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Total Customers</h3>
                        <p id="total-customers-count">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Books Low in Stock</h3>
                        <p id="low-stock-count" class="danger">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Today's Sales</h3>
                        <p id="today-sales-total">PKR 0.00</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Recent Sales</div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-recent-sales">
                                <tr>
                                    <td colspan="4">No recent sales.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Low Stock Books</div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-low-stock-books">
                                <tr>
                                    <td colspan="4">No books currently low in stock.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="books" class="page-content">
                <div class="page-header">
                    <h1>Books Management</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="add-book-btn"><i class="fas fa-plus"></i> Add New
                            Book</button>
                        <button class="btn btn-secondary" id="export-books-btn"><i class="fas fa-download"></i> Export
                            Books</button>
                        <button class="btn btn-secondary" id="import-books-btn"><i class="fas fa-upload"></i> Import
                            Books</button>
                    </div>
                </div>
                <div class="search-sort-controls card">
                    <div class="form-group">
                        <label for="book-search">Search Books</label>
                        <input type="text" id="book-search" placeholder="Search by title, author, ISBN, category...">
                    </div>
                    <div class="form-group">
                        <label for="book-sort">Sort By</label>
                        <select id="book-sort">
                            <option value="title-asc">Title (A-Z)</option>
                            <option value="title-desc">Title (Z-A)</option>
                            <option value="price-asc">Price (Low to High)</option>
                            <option value="price-desc">Price (High to Low)</option>
                            <option value="stock-asc">Stock (Low to High)</option>
                            <option value="stock-desc">Stock (High to Low)</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cover</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Category</th>
                                <th>ISBN</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="books-list">
                            <tr>
                                <td colspan="8">No books found.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="books-pagination">
                        <button id="books-prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                        <span id="books-page-info">Page 1 of 1</span>
                        <button id="books-next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </section>

            <section id="customers" class="page-content">
                <div class="page-header">
                    <h1>Customers Management</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="add-customer-btn"><i class="fas fa-plus"></i> Add New
                            Customer</button>
                        <button class="btn btn-secondary" id="export-customers-btn"><i class="fas fa-download"></i>
                            Export Customers</button>
                        <button class="btn btn-secondary" id="import-customers-btn"><i class="fas fa-upload"></i>
                            Import
                            Customers</button>
                    </div>
                </div>
                <div class="search-sort-controls card">
                    <div class="form-group">
                        <label for="customer-search">Search Customers</label>
                        <input type="text" id="customer-search" placeholder="Search by name, email, phone...">
                    </div>
                    <div class="form-group">
                        <label for="customer-filter-status">Status</label>
                        <select id="customer-filter-status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customers-list">
                            <tr>
                                <td colspan="6">No customers found.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="customers-pagination">
                        <button id="customers-prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                        <span id="customers-page-info">Page 1 of 1</span>
                        <button id="customers-next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </section>

            <section id="suppliers" class="page-content">
                <div class="page-header">
                    <h1>Suppliers Management</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="add-supplier-btn"><i class="fas fa-plus"></i> Add New
                            Supplier</button>
                        <button class="btn btn-secondary" id="export-suppliers-btn"><i class="fas fa-download"></i>
                            Export Suppliers</button>
                        <button class="btn btn-secondary" id="import-suppliers-btn"><i class="fas fa-upload"></i> Import
                            Suppliers</button>
                    </div>
                </div>
                <div class="search-sort-controls card">
                    <div class="form-group">
                        <label for="supplier-search">Search Suppliers</label>
                        <input type="text" id="supplier-search" placeholder="Search by name, contact, email...">
                    </div>
                </div>
                <div class="table-responsive card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact Person</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliers-list">
                            <tr>
                                <td colspan="5">No suppliers found.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="suppliers-pagination">
                        <button id="suppliers-prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                        <span id="suppliers-page-info">Page 1 of 1</span>
                        <button id="suppliers-next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </section>

            <section id="purchase-orders" class="page-content">
                <div class="page-header">
                    <h1>Purchase Orders</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="create-po-btn"><i class="fas fa-file-invoice"></i> Create
                            New
                            PO</button>
                        <button class="btn btn-secondary" id="export-pos-btn"><i class="fas fa-download"></i> Export
                            POs</button>
                    </div>
                </div>
                <div class="search-sort-controls card">
                    <div class="form-group">
                        <input type="text" id="po-search" placeholder="Search by PO ID, supplier, status...">
                    </div>
                    <div class="form-group">
                        <select id="po-status-filter">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="ordered">Ordered</option>
                            <option value="received">Received</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PO ID</th>
                                <th>Supplier</th>
                                <th>Order Date</th>
                                <th>Expected Date</th>
                                <th>Status</th>
                                <th>Total Items</th>
                                <th>Total Cost</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchase-orders-list">
                            <tr>
                                <td colspan="8">No purchase orders found.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="pos-pagination">
                        <button id="pos-prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                        <span id="pos-page-info">Page 1 of 1</span>
                        <button id="pos-next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </section>

            <section id="cart" class="page-content">
                <div class="page-header">
                    <h1>Cart & Sales</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="view-sales-history-btn"><i class="fas fa-history"></i>
                            View Sales History</button>
                        <button class="btn btn-secondary" id="export-sales-btn"><i class="fas fa-download"></i> Export
                            Sales</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Add Books to Cart</div>
                    <div class="search-sort-controls" style="margin-top: 0;">
                        <div class="form-group">
                            <input type="text" id="book-to-cart-search" placeholder="Search book to add to cart...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="books-for-cart-list">
                                <tr>
                                    <td colspan="5">No books found to add to cart.</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="pagination" id="books-for-cart-pagination">
                            <button id="books-for-cart-prev-page" disabled><i class="fas fa-chevron-left"></i>
                                Previous</button>
                            <span id="books-for-cart-page-info">Page 1 of 1</span>
                            <button id="books-for-cart-next-page" disabled>Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <div class="card-header">Current Cart (<span id="cart-total-items">0</span> items)</div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Discount</th>
                                    <th>Subtotal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cart-items-table">
                                <tr>
                                    <td colspan="6">Cart is empty.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="cart-summary">
                        <span>Total:</span>
                        <span id="cart-grand-total">PKR 0.00</span>
                    </div>
                    <div id="cart-actions">
                        <button class="btn btn-danger" id="clear-cart-btn" disabled><i class="fas fa-trash"></i> Clear
                            Cart</button>
                        <button class="btn btn-success" id="checkout-btn" disabled><i
                                class="fas fa-money-check-alt"></i> Checkout</button>
                    </div>
                </div>
            </section>

            <section id="promotions" class="page-content">
                <div class="page-header">
                    <h1>Promotions & Discounts</h1>
                    <button class="btn btn-primary" id="add-promotion-btn"><i class="fas fa-plus"></i> Add New
                        Promotion</button>
                </div>
                <div class="card">
                    <div class="card-header">Active Promotions</div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Applies To</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="promotions-list">
                                <tr>
                                    <td colspan="7">No promotions found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="expenses" class="page-content">
                <div class="page-header">
                    <h1>Expense Tracking</h1>
                    <button class="btn btn-primary" id="add-expense-btn"><i class="fas fa-plus"></i> Add New
                        Expense</button>
                </div>
                <div class="search-sort-controls card">
                    <div class="form-group">
                        <input type="text" id="expense-search" placeholder="Search by description, category...">
                    </div>
                    <div class="form-group">
                        <label for="expense-month-filter">Month</label>
                        <input type="month" id="expense-month-filter">
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Monthly Expenses: <span id="monthly-expenses-total">PKR 0.00</span></div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-list">
                                <tr>
                                    <td colspan="5">No expenses recorded.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="expenses-pagination">
                        <button id="expenses-prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                        <span id="expenses-page-info">Page 1 of 1</span>
                        <button id="expenses-next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </section>


            <section id="sales-history" class="page-content">
                <div class="page-header">
                    <h1>Sales History</h1>
                    <button class="btn btn-secondary" id="back-to-cart-btn"><i class="fas fa-arrow-left"></i> Back to
                        Cart</button>
                </div>
                <div class="search-sort-controls card">
                    <div class="form-group">
                        <input type="text" id="sale-search"
                            placeholder="Search by customer name, book title, sale ID...">
                    </div>
                </div>
                <div class="table-responsive card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Sale ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sales-list">
                            <tr>
                                <td colspan="6">No sales recorded.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="sales-pagination">
                        <button id="sales-prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                        <span id="sales-page-info">Page 1 of 1</span>
                        <button id="sales-next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </section>

            <section id="reports" class="page-content">
                <div class="page-header">
                    <h1>Reports & Analytics</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="export-current-report-btn" disabled><i
                                class="fas fa-download"></i> Export Current Report</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Generate Reports</div>
                    <div class="report-filters">
                        <div class="form-group">
                            <label for="report-type">Report Type</label>
                            <select id="report-type">
                                <option value="sales-daily">Daily Sales</option>
                                <option value="sales-weekly">Weekly Sales</option>
                                <option value="sales-monthly">Monthly Sales</option>
                                <option value="best-selling">Best-Selling Books</option>
                                <option value="best-selling-authors">Best-Selling Authors</option>
                                <option value="low-stock">Low Stock Books</option>
                                <option value="expenses-summary">Expenses Summary</option>
                            </select>
                        </div>
                        <div class="form-group" id="report-date-filter">
                            <label for="report-date">Date</label>
                            <input type="date" id="report-date">
                        </div>
                        <div class="form-group" id="report-month-filter">
                            <label for="report-month">Month</label>
                            <input type="month" id="report-month">
                        </div>
                        <div class="form-group" id="report-year-filter" style="display: none;">
                            <label for="report-year">Year</label>
                            <input type="number" id="report-year" min="2000" max="2100">
                        </div>
                    </div>
                    <button class="btn btn-primary" id="generate-report-btn"><i class="fas fa-chart-bar"></i> Generate
                        Report</button>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <div class="card-header" id="report-results-header">Report Results</div>
                    <div class="chart-container">
                        <canvas id="report-chart"></canvas>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="report-results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Result</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3">Select a report type and generate to see results.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="backup-restore" class="page-content">
                <div class="page-header">
                    <h1>Backup & Restore</h1>
                </div>
                <div class="card">
                    <div class="card-header">Export All Data</div>
                    <p>Export all your Bookshop Management data (Books, Customers, Sales, Suppliers, POs, Promotions,
                        Expenses) as a JSON file. This file can
                        be used to restore your data later.</p>
                    <button class="btn btn-primary" id="export-all-data-btn"><i class="fas fa-download"></i> Export All
                        Data</button>
                </div>
                <div class="card" style="margin-top: 30px;">
                    <div class="card-header">Import All Data</div>
                    <p>Import a previously exported JSON file to restore your Bookshop Management data. <strong>Warning:
                            This will overwrite ALL existing data!</strong></p>
                    <div class="form-group">
                        <label for="import-file">Select JSON File to Import</label>
                        <input type="file" id="import-file" accept=".json">
                    </div>
                    <button class="btn btn-danger" id="import-all-data-btn" disabled><i class="fas fa-upload"></i>
                        Import All Data</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="book-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="book-modal-title">Add New Book</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="book-form">
                <input type="hidden" id="book-id">
                <div class="flex-group">
                    <div class="form-group">
                        <label for="book-title">Title</label>
                        <input type="text" id="book-title" required>
                    </div>
                    <div class="form-group">
                        <label for="book-author">Author</label>
                        <input type="text" id="book-author" required>
                    </div>
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="book-category">Category</label>
                        <input type="text" id="book-category" required>
                    </div>
                    <div class="form-group">
                        <label for="book-isbn">ISBN</label>
                        <input type="text" id="book-isbn" required>
                    </div>
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="book-publisher">Publisher</label>
                        <input type="text" id="book-publisher">
                    </div>
                    <div class="form-group">
                        <label for="book-year">Year</label>
                        <input type="number" id="book-year" min="1000" max="2100">
                    </div>
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="book-price">Price (PKR)</label>
                        <input type="number" id="book-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="book-stock">Stock Quantity</label>
                        <input type="number" id="book-stock" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="book-description">Description</label>
                    <textarea id="book-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="book-cover-image">Cover Image</label>
                    <input type="file" id="book-cover-image" accept="image/*">
                    <div class="img-preview" id="book-cover-preview">
                        <img src="" alt="Cover Preview" style="display: none;">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Book</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-books-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Books</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="import-books-form">
                <div class="form-group">
                    <label for="import-books-file">Select JSON File to Import</label>
                    <input type="file" id="import-books-file" accept=".json" required>
                </div>
                <div class="form-group">
                    <label>If book with same ISBN exists:</label>
                    <div>
                        <input type="radio" id="import-books-skip" name="import-conflict-books" value="skip" checked>
                        <label for="import-books-skip">Skip (default)</label>
                    </div>
                    <div>
                        <input type="radio" id="import-books-update" name="import-conflict-books" value="update">
                        <label for="import-books-update">Update existing book</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Books</button>
                </div>
            </form>
        </div>
    </div>

    <div id="restock-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Restock Book</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="restock-form">
                <input type="hidden" id="restock-book-id">
                <div class="form-group">
                    <label for="restock-book-title">Book Title</label>
                    <input type="text" id="restock-book-title" readonly>
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="restock-current-stock">Current Stock</label>
                        <input type="number" id="restock-current-stock" readonly>
                    </div>
                    <div class="form-group">
                        <label for="restock-quantity">Quantity to Add</label>
                        <input type="number" id="restock-quantity" min="1" value="1" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Restock</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customer-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customer-modal-title">Add New Customer</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="form-group">
                    <label for="customer-name">Name</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="customer-phone">Phone</label>
                        <input type="tel" id="customer-phone">
                    </div>
                    <div class="form-group">
                        <label for="customer-email">Email</label>
                        <input type="email" id="customer-email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="customer-address">Address</label>
                    <textarea id="customer-address" rows="2"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-customers-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Customers</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="import-customers-form">
                <div class="form-group">
                    <label for="import-customers-file">Select JSON File to Import</label>
                    <input type="file" id="import-customers-file" accept=".json" required>
                </div>
                <div class="form-group">
                    <label>If customer with same email exists:</label>
                    <div>
                        <input type="radio" id="import-customers-skip" name="import-conflict-customers" value="skip"
                            checked>
                        <label for="import-customers-skip">Skip (default)</label>
                    </div>
                    <div>
                        <input type="radio" id="import-customers-update" name="import-conflict-customers"
                            value="update">
                        <label for="import-customers-update">Update existing customer</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Customers</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customer-history-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="customer-history-title">Purchase History for Customer</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Sale ID</th>
                            <th>Date</th>
                            <th>Items</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="customer-history-list">
                        <tr>
                            <td colspan="4">No purchases found for this customer.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="form-actions" style="justify-content: center;">
                <button type="button" class="btn btn-secondary modal-close">Close</button>
            </div>
        </div>
    </div>

    <div id="supplier-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="supplier-modal-title">Add New Supplier</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="supplier-form">
                <input type="hidden" id="supplier-id">
                <div class="form-group">
                    <label for="supplier-name">Supplier Name</label>
                    <input type="text" id="supplier-name" required>
                </div>
                <div class="form-group">
                    <label for="supplier-contact-person">Contact Person</label>
                    <input type="text" id="supplier-contact-person">
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="supplier-phone">Phone</label>
                        <input type="tel" id="supplier-phone">
                    </div>
                    <div class="form-group">
                        <label for="supplier-email">Email</label>
                        <input type="email" id="supplier-email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="supplier-address">Address</label>
                    <textarea id="supplier-address" rows="2"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Supplier</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-suppliers-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Suppliers</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="import-suppliers-form">
                <div class="form-group">
                    <label for="import-suppliers-file">Select JSON File to Import</label>
                    <input type="file" id="import-suppliers-file" accept=".json" required>
                </div>
                <div class="form-group">
                    <label>If supplier with same email exists:</label>
                    <div>
                        <input type="radio" id="import-suppliers-skip" name="import-conflict-suppliers" value="skip"
                            checked>
                        <label for="import-suppliers-skip">Skip (default)</label>
                    </div>
                    <div>
                        <input type="radio" id="import-suppliers-update" name="import-conflict-suppliers"
                            value="update">
                        <label for="import-suppliers-update">Update existing supplier</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Suppliers</button>
                </div>
            </form>
        </div>
    </div>


    <div id="purchase-order-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="po-modal-title">Create New Purchase Order</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="po-form">
                <input type="hidden" id="po-id">
                <div class="flex-group">
                    <div class="form-group">
                        <label for="po-supplier">Supplier</label>
                        <select id="po-supplier" required></select>
                    </div>
                    <div class="form-group">
                        <label for="po-order-date">Order Date</label>
                        <input type="date" id="po-order-date" required>
                    </div>
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="po-expected-date">Expected Delivery Date</label>
                        <input type="date" id="po-expected-date">
                    </div>
                    <div class="form-group">
                        <label for="po-status">Status</label>
                        <select id="po-status">
                            <option value="pending">Pending</option>
                            <option value="ordered">Ordered</option>
                            <option value="received">Received</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div class="card-header" style="margin-top: 20px;">Order Items</div>
                <div class="search-sort-controls">
                    <div class="form-group item-picker">
                        <label for="po-book-search">Add Book</label>
                        <input type="text" id="po-book-search" placeholder="Search book to add..." autocomplete="off">
                        <div id="po-book-search-results" class="item-picker-results"></div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Book Title</th>
                                <th>Quantity</th>
                                <th>Unit Cost</th>
                                <th>Subtotal</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="po-items-list">
                            <tr>
                                <td colspan="5">No items added to this purchase order.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="po-summary"
                    style="margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); text-align: right; font-weight: bold;">
                    Total Cost: <span id="po-grand-total">PKR 0.00</span>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Purchase Order</button>
                    <button type="button" class="btn btn-success" id="receive-po-btn" style="display: none;"><i
                            class="fas fa-check-double"></i> Receive Order</button>
                </div>
            </form>
        </div>
    </div>

    <div id="checkout-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Checkout</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="checkout-form">
                <div class="form-group">
                    <label for="checkout-customer">Select Customer (Optional)</label>
                    <select id="checkout-customer">
                        <option value="">Guest Customer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="checkout-promotion-code">Promotion Code (Optional)</label>
                    <input type="text" id="checkout-promotion-code" placeholder="Enter promo code">
                    <button type="button" class="btn btn-sm btn-info" id="apply-promo-btn"
                        style="margin-top: 5px;">Apply</button>
                </div>
                <div class="form-group">
                    <label for="checkout-subtotal">Subtotal</label>
                    <input type="text" id="checkout-subtotal" readonly>
                </div>
                <div class="form-group" id="checkout-discount-display" style="display: none;">
                    <label for="checkout-discount">Discount Applied</label>
                    <input type="text" id="checkout-discount" readonly>
                </div>
                <div class="form-group">
                    <label for="checkout-total">Total Amount</label>
                    <input type="text" id="checkout-total" readonly>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-success">Complete Sale</button>
                </div>
            </form>
        </div>
    </div>

    <div id="receipt-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Sale Receipt</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div id="receipt-content" style="font-family: monospace; font-size: 0.9em; line-height: 1.4;">
                <p style="text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Bookshop
                    Receipt</p>
                <hr style="border: 1px dashed var(--border-color); margin: 10px 0;">
                <p><strong>Sale ID:</strong> <span id="receipt-sale-id"></span></p>
                <p><strong>Date:</strong> <span id="receipt-date"></span></p>
                <p><strong>Customer:</strong> <span id="receipt-customer"></span></p>
                <hr style="border: 1px dashed var(--border-color); margin: 10px 0;">
                <p style="font-weight: bold;">Items:</p>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 2px 0;">Book</th>
                            <th style="text-align: right; padding: 2px 0;">Qty</th>
                            <th style="text-align: right; padding: 2px 0;">Price</th>
                            <th style="text-align: right; padding: 2px 0;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items-list">
                    </tbody>
                </table>
                <hr style="border: 1px dashed var(--border-color); margin: 10px 0;">
                <p style="text-align: right;">Subtotal: <span id="receipt-subtotal"></span></p>
                <p style="text-align: right; display: none;" id="receipt-discount-line">Discount: <span
                        id="receipt-discount-value"></span></p>
                <p style="font-size: 1.1em; font-weight: bold; text-align: right;">Total: <span
                        id="receipt-grand-total"></span></p>
                <hr style="border: 1px dashed var(--border-color); margin: 10px 0;">
                <p style="text-align: center; margin-top: 15px;">Thank you for your purchase!</p>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary modal-close">Close</button>
                <button type="button" class="btn btn-info" id="print-receipt-btn"><i class="fas fa-print"></i>
                    Print</button>
                <button type="button" class="btn btn-success" id="download-receipt-btn"><i class="fas fa-download"></i>
                    Download PDF</button>
            </div>
        </div>
    </div>

    <div id="view-sale-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Sale Details</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div id="sale-details-content">
                <p><strong>Sale ID:</strong> <span id="sale-details-id"></span></p>
                <p><strong>Date:</strong> <span id="sale-details-date"></span></p>
                <p><strong>Customer:</strong> <span id="sale-details-customer"></span></p>
                <p style="font-weight: bold; margin-top: 15px;">Items:</p>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Book</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Discount</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="sale-details-items">
                        </tbody>
                    </table>
                </div>
                <p style="font-size: 1.1em; font-weight: bold; text-align: right; margin-top: 15px;">Subtotal: <span
                        id="sale-details-subtotal"></span></p>
                <p style="font-size: 1.1em; font-weight: bold; text-align: right;" id="sale-details-discount-line">
                    Discount:
                    <span id="sale-details-discount-value"></span>
                </p>
                <p style="font-size: 1.1em; font-weight: bold; text-align: right;">Total: <span
                        id="sale-details-total"></span></p>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary modal-close">Close</button>
                <button type="button" class="btn btn-info" id="reprint-receipt-btn"><i class="fas fa-print"></i> Print
                    Receipt</button>
            </div>
        </div>
    </div>

    <div id="promotion-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="promotion-modal-title">Add New Promotion</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="promotion-form">
                <input type="hidden" id="promotion-id">
                <div class="form-group">
                    <label for="promotion-code">Promotion Code</label>
                    <input type="text" id="promotion-code" required>
                </div>
                <div class="promotion-type-toggle">
                    <button type="button" id="promo-type-percentage" class="btn btn-secondary active"
                        data-type="percentage">Percentage Off</button>
                    <button type="button" id="promo-type-fixed" class="btn btn-secondary" data-type="fixed">Fixed
                        Amount Off</button>
                </div>
                <input type="hidden" id="promotion-type" value="percentage">
                <div class="form-group">
                    <label for="promotion-value">Discount Value</label>
                    <input type="number" id="promotion-value" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="promotion-applies-to">Applies To</label>
                    <select id="promotion-applies-to" required>
                        <option value="all">Entire Order</option>
                        <option value="specific-book">Specific Book</option>
                        <option value="specific-category">Specific Category</option>
                    </select>
                </div>
                <div class="form-group" id="promotion-book-group" style="display: none;">
                    <label for="promotion-book-id">Select Book</label>
                    <select id="promotion-book-id"></select>
                </div>
                <div class="form-group" id="promotion-category-group" style="display: none;">
                    <label for="promotion-category">Select Category</label>
                    <input type="text" id="promotion-category" list="book-categories-datalist">
                    <datalist id="book-categories-datalist"></datalist>
                </div>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="promotion-start-date">Start Date</label>
                        <input type="date" id="promotion-start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="promotion-end-date">End Date</label>
                        <input type="date" id="promotion-end-date">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Promotion</button>
                </div>
            </form>
        </div>
    </div>

    <div id="expense-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="expense-modal-title">Add New Expense</h3>
                <button class="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <form id="expense-form">
                <input type="hidden" id="expense-id">
                <div class="form-group">
                    <label for="expense-date">Date</label>
                    <input type="date" id="expense-date" required>
                </div>
                <div class="form-group">
                    <label for="expense-category">Category</label>
                    <input type="text" id="expense-category" list="expense-categories-datalist" required>
                    <datalist id="expense-categories-datalist">
                        <option value="Rent">
                        <option value="Utilities">
                        <option value="Salaries">
                        <option value="Marketing">
                        <option value="Supplies">
                        <option value="Maintenance">
                        <option value="Other">
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="expense-description">Description</label>
                    <textarea id="expense-description" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="expense-amount">Amount (PKR)</label>
                    <input type="number" id="expense-amount" min="0" step="0.01" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Expense</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const DB_NAME = 'bookshopDB';
        const DB_VERSION = 2; // Incremented DB version for new stores
        const OBJECT_STORES = {
            BOOKS: 'books',
            CUSTOMERS: 'customers',
            SUPPLIERS: 'suppliers',
            PURCHASE_ORDERS: 'purchaseOrders',
            SALES: 'sales',
            PROMOTIONS: 'promotions',
            EXPENSES: 'expenses',
            USERS: 'users' // For future user management, though not fully implemented in current scope
        };

        let db;
        let currentCart = [];
        let currentReportData = [];
        let currentPage = 'dashboard';
        let reportChartInstance = null;
        let appliedPromotion = null;

        const PAGE_SIZE = 10; // Number of items per page for pagination

        const pagination = {
            books: {
                currentPage: 1,
                totalPages: 1,
                elements: {
                    prev: null,
                    next: null,
                    info: null,
                }
            },
            customers: {
                currentPage: 1,
                totalPages: 1,
                elements: {
                    prev: null,
                    next: null,
                    info: null,
                }
            },
            suppliers: {
                currentPage: 1,
                totalPages: 1,
                elements: {
                    prev: null,
                    next: null,
                    info: null,
                }
            },
            purchaseOrders: {
                currentPage: 1,
                totalPages: 1,
                elements: {
                    prev: null,
                    next: null,
                    info: null,
                }
            },
            booksForCart: {
                currentPage: 1,
                totalPages: 1,
                elements: {
                    prev: null,
                    next: null,
                    info: null,
                }
            },
            sales: {
                currentPage: 1,
                totalPages: 1,
                elements: {
                    prev: null,
                    next: null,
                    info: null,
                }
            },
            expenses: {
                currentPage: 1,
                totalPages: 1,
                elements: {
                    prev: null,
                    next: null,
                    info: null,
                }
            }
        };


        const elements = {
            appContainer: document.getElementById('app-container'),
            sidebar: document.querySelector('.sidebar'),
            hamburgerMenu: document.getElementById('hamburger-menu'),
            darkModeSwitch: document.getElementById('dark-mode-switch'),
            navLinks: document.querySelectorAll('.nav-link'),
            pageContents: document.querySelectorAll('.page-content'),
            toastContainer: document.getElementById('toast-container'),

            // Dashboard
            totalBooksCount: document.getElementById('total-books-count'),
            totalCustomersCount: document.getElementById('total-customers-count'),
            lowStockCount: document.getElementById('low-stock-count'),
            todaySalesTotal: document.getElementById('today-sales-total'),
            dashboardRecentSales: document.getElementById('dashboard-recent-sales'),
            dashboardLowStockBooks: document.getElementById('dashboard-low-stock-books'),

            // Books
            addBookBtn: document.getElementById('add-book-btn'),
            exportBooksBtn: document.getElementById('export-books-btn'),
            importBooksBtn: document.getElementById('import-books-btn'),
            bookSearch: document.getElementById('book-search'),
            bookSort: document.getElementById('book-sort'),
            booksList: document.getElementById('books-list'),
            booksPagination: document.getElementById('books-pagination'),
            booksPrevPage: document.getElementById('books-prev-page'),
            booksNextPage: document.getElementById('books-next-page'),
            booksPageInfo: document.getElementById('books-page-info'),
            importBooksModal: document.getElementById('import-books-modal'),
            importBooksForm: document.getElementById('import-books-form'),
            importBooksFile: document.getElementById('import-books-file'),
            importBooksSkip: document.getElementById('import-books-skip'),
            importBooksUpdate: document.getElementById('import-books-update'),

            // Customers
            addCustomerBtn: document.getElementById('add-customer-btn'),
            exportCustomersBtn: document.getElementById('export-customers-btn'),
            importCustomersBtn: document.getElementById('import-customers-btn'),
            customerSearch: document.getElementById('customer-search'),
            customerFilterStatus: document.getElementById('customer-filter-status'),
            customersList: document.getElementById('customers-list'),
            customersPagination: document.getElementById('customers-pagination'),
            customersPrevPage: document.getElementById('customers-prev-page'),
            customersNextPage: document.getElementById('customers-next-page'),
            customersPageInfo: document.getElementById('customers-page-info'),
            importCustomersModal: document.getElementById('import-customers-modal'),
            importCustomersForm: document.getElementById('import-customers-form'),
            importCustomersFile: document.getElementById('import-customers-file'),
            importCustomersSkip: document.getElementById('import-customers-skip'),
            importCustomersUpdate: document.getElementById('import-customers-update'),

            // Suppliers
            addSupplierBtn: document.getElementById('add-supplier-btn'),
            exportSuppliersBtn: document.getElementById('export-suppliers-btn'),
            importSuppliersBtn: document.getElementById('import-suppliers-btn'),
            supplierSearch: document.getElementById('supplier-search'),
            suppliersList: document.getElementById('suppliers-list'),
            suppliersPagination: document.getElementById('suppliers-pagination'),
            suppliersPrevPage: document.getElementById('suppliers-prev-page'),
            suppliersNextPage: document.getElementById('suppliers-next-page'),
            suppliersPageInfo: document.getElementById('suppliers-page-info'),
            importSuppliersModal: document.getElementById('import-suppliers-modal'),
            importSuppliersForm: document.getElementById('import-suppliers-form'),
            importSuppliersFile: document.getElementById('import-suppliers-file'),
            importSuppliersSkip: document.getElementById('import-suppliers-skip'),
            importSuppliersUpdate: document.getElementById('import-suppliers-update'),

            // Purchase Orders
            createPoBtn: document.getElementById('create-po-btn'),
            exportPosBtn: document.getElementById('export-pos-btn'),
            poSearch: document.getElementById('po-search'),
            poStatusFilter: document.getElementById('po-status-filter'),
            purchaseOrdersList: document.getElementById('purchase-orders-list'),
            posPagination: document.getElementById('pos-pagination'),
            posPrevPage: document.getElementById('pos-prev-page'),
            posNextPage: document.getElementById('pos-next-page'),
            posPageInfo: document.getElementById('pos-page-info'),


            // Cart & Sales
            viewSalesHistoryBtn: document.getElementById('view-sales-history-btn'),
            exportSalesBtn: document.getElementById('export-sales-btn'),
            backToCartBtn: document.getElementById('back-to-cart-btn'),
            bookToCartSearch: document.getElementById('book-to-cart-search'),
            booksForCartList: document.getElementById('books-for-cart-list'),
            booksForCartPagination: document.getElementById('books-for-cart-pagination'),
            booksForCartPrevPage: document.getElementById('books-for-cart-prev-page'),
            booksForCartNextPage: document.getElementById('books-for-cart-next-page'),
            booksForCartPageInfo: document.getElementById('books-for-cart-page-info'),
            cartTotalItems: document.getElementById('cart-total-items'),
            cartItemsTable: document.getElementById('cart-items-table'),
            cartGrandTotal: document.getElementById('cart-grand-total'),
            clearCartBtn: document.getElementById('clear-cart-btn'),
            checkoutBtn: document.getElementById('checkout-btn'),
            salesList: document.getElementById('sales-list'),
            salesPagination: document.getElementById('sales-pagination'),
            salesPrevPage: document.getElementById('sales-prev-page'),
            salesNextPage: document.getElementById('sales-next-page'),
            salesPageInfo: document.getElementById('sales-page-info'),
            saleSearch: document.getElementById('sale-search'),

            // Promotions
            addPromotionBtn: document.getElementById('add-promotion-btn'),
            promotionsList: document.getElementById('promotions-list'),
            promotionTypePercentage: document.getElementById('promo-type-percentage'),
            promotionTypeFixed: document.getElementById('promo-type-fixed'),
            promotionType: document.getElementById('promotion-type'),
            promotionAppliesTo: document.getElementById('promotion-applies-to'),
            promotionBookGroup: document.getElementById('promotion-book-group'),
            promotionBookId: document.getElementById('promotion-book-id'),
            promotionCategoryGroup: document.getElementById('promotion-category-group'),
            promotionCategory: document.getElementById('promotion-category'),
            bookCategoriesDatalist: document.getElementById('book-categories-datalist'),


            // Expenses
            addExpenseBtn: document.getElementById('add-expense-btn'),
            expenseSearch: document.getElementById('expense-search'),
            expenseMonthFilter: document.getElementById('expense-month-filter'),
            expensesList: document.getElementById('expenses-list'),
            monthlyExpensesTotal: document.getElementById('monthly-expenses-total'),
            expensesPagination: document.getElementById('expenses-pagination'),
            expensesPrevPage: document.getElementById('expenses-prev-page'),
            expensesNextPage: document.getElementById('expenses-next-page'),
            expensesPageInfo: document.getElementById('expenses-page-info'),


            // Reports
            reportType: document.getElementById('report-type'),
            reportDateFilter: document.getElementById('report-date-filter'),
            reportDate: document.getElementById('report-date'),
            reportMonthFilter: document.getElementById('report-month-filter'),
            reportMonth: document.getElementById('report-month'),
            reportYearFilter: document.getElementById('report-year-filter'),
            reportYear: document.getElementById('report-year'),
            generateReportBtn: document.getElementById('generate-report-btn'),
            exportCurrentReportBtn: document.getElementById('export-current-report-btn'),
            reportResultsHeader: document.getElementById('report-results-header'),
            reportResultsTable: document.getElementById('report-results-table'),
            reportChart: document.getElementById('report-chart'),

            // Backup / Restore
            exportAllDataBtn: document.getElementById('export-all-data-btn'),
            importFile: document.getElementById('import-file'),
            importAllDataBtn: document.getElementById('import-all-data-btn'),

            // Modals
            bookModal: document.getElementById('book-modal'),
            bookModalTitle: document.getElementById('book-modal-title'),
            bookForm: document.getElementById('book-form'),
            bookId: document.getElementById('book-id'),
            bookTitle: document.getElementById('book-title'),
            bookAuthor: document.getElementById('book-author'),
            bookCategory: document.getElementById('book-category'),
            bookIsbn: document.getElementById('book-isbn'),
            bookPublisher: document.getElementById('book-publisher'),
            bookYear: document.getElementById('book-year'),
            bookPrice: document.getElementById('book-price'),
            bookStock: document.getElementById('book-stock'),
            bookDescription: document.getElementById('book-description'),
            bookCoverImage: document.getElementById('book-cover-image'),
            bookCoverPreview: document.getElementById('book-cover-preview').querySelector('img'),

            restockModal: document.getElementById('restock-modal'),
            restockForm: document.getElementById('restock-form'),
            restockBookId: document.getElementById('restock-book-id'),
            restockBookTitle: document.getElementById('restock-book-title'),
            restockCurrentStock: document.getElementById('restock-current-stock'),
            restockQuantity: document.getElementById('restock-quantity'),

            customerModal: document.getElementById('customer-modal'),
            customerModalTitle: document.getElementById('customer-modal-title'),
            customerForm: document.getElementById('customer-form'),
            customerId: document.getElementById('customer-id'),
            customerName: document.getElementById('customer-name'),
            customerPhone: document.getElementById('customer-phone'),
            customerEmail: document.getElementById('customer-email'),
            customerAddress: document.getElementById('customer-address'),

            customerHistoryModal: document.getElementById('customer-history-modal'),
            customerHistoryTitle: document.getElementById('customer-history-title'),
            customerHistoryList: document.getElementById('customer-history-list'),

            supplierModal: document.getElementById('supplier-modal'),
            supplierModalTitle: document.getElementById('supplier-modal-title'),
            supplierForm: document.getElementById('supplier-form'),
            supplierId: document.getElementById('supplier-id'),
            supplierName: document.getElementById('supplier-name'),
            supplierContactPerson: document.getElementById('supplier-contact-person'),
            supplierPhone: document.getElementById('supplier-phone'),
            supplierEmail: document.getElementById('supplier-email'),
            supplierAddress: document.getElementById('supplier-address'),


            purchaseOrderModal: document.getElementById('purchase-order-modal'),
            poModalTitle: document.getElementById('po-modal-title'),
            poForm: document.getElementById('po-form'),
            poId: document.getElementById('po-id'),
            poSupplier: document.getElementById('po-supplier'),
            poOrderDate: document.getElementById('po-order-date'),
            poExpectedDate: document.getElementById('po-expected-date'),
            poStatus: document.getElementById('po-status'),
            poBookSearch: document.getElementById('po-book-search'),
            poBookSearchResults: document.getElementById('po-book-search-results'),
            poItemsList: document.getElementById('po-items-list'),
            poGrandTotal: document.getElementById('po-grand-total'),
            receivePoBtn: document.getElementById('receive-po-btn'),

            checkoutModal: document.getElementById('checkout-modal'),
            checkoutForm: document.getElementById('checkout-form'),
            checkoutCustomer: document.getElementById('checkout-customer'),
            checkoutPromotionCode: document.getElementById('checkout-promotion-code'),
            applyPromoBtn: document.getElementById('apply-promo-btn'),
            checkoutSubtotal: document.getElementById('checkout-subtotal'),
            checkoutDiscountDisplay: document.getElementById('checkout-discount-display'),
            checkoutDiscount: document.getElementById('checkout-discount'),
            checkoutTotal: document.getElementById('checkout-total'),

            receiptModal: document.getElementById('receipt-modal'),
            receiptSaleId: document.getElementById('receipt-sale-id'),
            receiptDate: document.getElementById('receipt-date'),
            receiptCustomer: document.getElementById('receipt-customer'),
            receiptItemsList: document.getElementById('receipt-items-list'),
            receiptSubtotal: document.getElementById('receipt-subtotal'),
            receiptDiscountLine: document.getElementById('receipt-discount-line'),
            receiptDiscountValue: document.getElementById('receipt-discount-value'),
            receiptGrandTotal: document.getElementById('receipt-grand-total'),
            printReceiptBtn: document.getElementById('print-receipt-btn'),
            downloadReceiptBtn: document.getElementById('download-receipt-btn'),

            viewSaleModal: document.getElementById('view-sale-modal'),
            saleDetailsId: document.getElementById('sale-details-id'),
            saleDetailsDate: document.getElementById('sale-details-date'),
            saleDetailsCustomer: document.getElementById('sale-details-customer'),
            saleDetailsItems: document.getElementById('sale-details-items'),
            saleDetailsSubtotal: document.getElementById('sale-details-subtotal'),
            saleDetailsDiscountLine: document.getElementById('sale-details-discount-line'),
            saleDetailsDiscountValue: document.getElementById('sale-details-discount-value'),
            saleDetailsTotal: document.getElementById('sale-details-total'),
            reprintReceiptBtn: document.getElementById('reprint-receipt-btn'),

            promotionModal: document.getElementById('promotion-modal'),
            promotionModalTitle: document.getElementById('promotion-modal-title'),
            promotionForm: document.getElementById('promotion-form'),
            promotionId: document.getElementById('promotion-id'),
            promotionCode: document.getElementById('promotion-code'),
            promotionValue: document.getElementById('promotion-value'),
            promotionStartDate: document.getElementById('promotion-start-date'),
            promotionEndDate: document.getElementById('promotion-end-date'),

            expenseModal: document.getElementById('expense-modal'),
            expenseModalTitle: document.getElementById('expense-modal-title'),
            expenseForm: document.getElementById('expense-form'),
            expenseId: document.getElementById('expense-id'),
            expenseDate: document.getElementById('expense-date'),
            expenseCategory: document.getElementById('expense-category'),
            expenseDescription: document.getElementById('expense-description'),
            expenseAmount: document.getElementById('expense-amount'),

            modalCloseButtons: document.querySelectorAll('.modal-close')
        };

        const formatCurrency = (amount) => `PKR ${parseFloat(amount).toFixed(2)}`;
        const formatDate = (timestamp) => new Date(timestamp).toLocaleDateString('en-PK', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        const formatShortDate = (timestamp) => new Date(timestamp).toLocaleDateString('en-PK', {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric'
        });

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            const icon = type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-times-circle' :
                    type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        function showModal(modalElement) {
            modalElement.classList.add('active');
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('active');
        }

        function initDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    if (!db.objectStoreNames.contains(OBJECT_STORES.BOOKS)) {
                        const bookStore = db.createObjectStore(OBJECT_STORES.BOOKS, {
                            keyPath: 'id'
                        });
                        bookStore.createIndex('title', 'title', {
                            unique: false
                        });
                        bookStore.createIndex('author', 'author', {
                            unique: false
                        });
                        bookStore.createIndex('isbn', 'isbn', {
                            unique: true
                        });
                        bookStore.createIndex('category', 'category', {
                            unique: false
                        });
                    }
                    if (!db.objectStoreNames.contains(OBJECT_STORES.CUSTOMERS)) {
                        const customerStore = db.createObjectStore(OBJECT_STORES.CUSTOMERS, {
                            keyPath: 'id'
                        });
                        customerStore.createIndex('name', 'name', {
                            unique: false
                        });
                        customerStore.createIndex('email', 'email', {
                            unique: false
                        });
                        customerStore.createIndex('phone', 'phone', {
                            unique: false
                        });
                        customerStore.createIndex('isActive', 'isActive', {
                            unique: false
                        });
                    }
                    if (!db.objectStoreNames.contains(OBJECT_STORES.SUPPLIERS)) {
                        const supplierStore = db.createObjectStore(OBJECT_STORES.SUPPLIERS, {
                            keyPath: 'id'
                        });
                        supplierStore.createIndex('name', 'name', {
                            unique: false
                        });
                        supplierStore.createIndex('email', 'email', {
                            unique: false
                        });
                    }
                    if (!db.objectStoreNames.contains(OBJECT_STORES.PURCHASE_ORDERS)) {
                        const poStore = db.createObjectStore(OBJECT_STORES.PURCHASE_ORDERS, {
                            keyPath: 'id'
                        });
                        poStore.createIndex('supplierId', 'supplierId', {
                            unique: false
                        });
                        poStore.createIndex('orderDate', 'orderDate', {
                            unique: false
                        });
                        poStore.createIndex('status', 'status', {
                            unique: false
                        });
                    }
                    if (!db.objectStoreNames.contains(OBJECT_STORES.SALES)) {
                        const salesStore = db.createObjectStore(OBJECT_STORES.SALES, {
                            keyPath: 'id'
                        });
                        salesStore.createIndex('timestamp', 'timestamp', {
                            unique: false
                        });
                        salesStore.createIndex('customerId', 'customerId', {
                            unique: false
                        });
                    }
                    if (!db.objectStoreNames.contains(OBJECT_STORES.PROMOTIONS)) {
                        const promoStore = db.createObjectStore(OBJECT_STORES.PROMOTIONS, {
                            keyPath: 'id'
                        });
                        promoStore.createIndex('code', 'code', {
                            unique: true
                        });
                        promoStore.createIndex('endDate', 'endDate', {
                            unique: false
                        });
                    }
                    if (!db.objectStoreNames.contains(OBJECT_STORES.EXPENSES)) {
                        const expenseStore = db.createObjectStore(OBJECT_STORES.EXPENSES, {
                            keyPath: 'id'
                        });
                        expenseStore.createIndex('date', 'date', {
                            unique: false
                        });
                        expenseStore.createIndex('category', 'category', {
                            unique: false
                        });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                    populateInitialDataIfNeeded();
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    showToast('Failed to open database.', 'error');
                    reject(event.target.error);
                };
            });
        }

        async function populateInitialDataIfNeeded() {
            const books = await getAllData(OBJECT_STORES.BOOKS);
            const customers = await getAllData(OBJECT_STORES.CUSTOMERS);
            const suppliers = await getAllData(OBJECT_STORES.SUPPLIERS);
            const sales = await getAllData(OBJECT_STORES.SALES);
            const expenses = await getAllData(OBJECT_STORES.EXPENSES);

            if (books.length === 0 && customers.length === 0 && suppliers.length === 0 && sales.length === 0 && expenses.length === 0) {
                const sampleBooks = [{
                    id: crypto.randomUUID(),
                    title: 'The Alchemist',
                    author: 'Paulo Coelho',
                    category: 'Fiction',
                    isbn: '978-0061122415',
                    publisher: 'HarperOne',
                    year: 1988,
                    price: 850.00,
                    stock: 12,
                    description: 'A philosophical novel about a young shepherd boy named Santiago who journeys to find a treasure.',
                    coverImage: ''
                }, {
                    id: crypto.randomUUID(),
                    title: 'Sapiens: A Brief History of Humankind',
                    author: 'Yuval Noah Harari',
                    category: 'History',
                    isbn: '978-0062316097',
                    publisher: 'Harper Perennial',
                    year: 2014,
                    price: 1200.00,
                    stock: 7,
                    description: 'Explores the history of humanity from the Stone Age to the twenty-first century.',
                    coverImage: ''
                }, {
                    id: crypto.randomUUID(),
                    title: 'The Art of Thinking Clearly',
                    author: 'Rolf Dobelli',
                    category: 'Self-Help',
                    isbn: '978-0062218391',
                    publisher: 'HarperCollins',
                    year: 2011,
                    price: 700.00,
                    stock: 3,
                    description: '99 ways to improve your decision-making and avoid common thinking errors.',
                    coverImage: ''
                }, {
                    id: crypto.randomUUID(),
                    title: '1984',
                    author: 'George Orwell',
                    category: 'Dystopian',
                    isbn: '978-0451524935',
                    publisher: 'Signet Classic',
                    year: 1949,
                    price: 600.00,
                    stock: 20,
                    description: 'A dystopian social science fiction novel and cautionary tale.',
                    coverImage: ''
                }, {
                    id: crypto.randomUUID(),
                    title: 'Rich Dad Poor Dad',
                    author: 'Robert Kiyosaki',
                    category: 'Finance',
                    isbn: '978-0446677455',
                    publisher: 'Plata Publishing',
                    year: 1997,
                    price: 950.00,
                    stock: 4,
                    description: 'Explodes the myth that you need to earn a high income to become rich.',
                    coverImage: ''
                }, {
                    id: crypto.randomUUID(),
                    title: 'To Kill a Mockingbird',
                    author: 'Harper Lee',
                    category: 'Classic',
                    isbn: '978-0446310789',
                    publisher: 'Grand Central Publishing',
                    year: 1960,
                    price: 750.00,
                    stock: 15,
                    description: 'A novel about the serious issues of rape and racial inequality.',
                    coverImage: ''
                }];

                const sampleCustomers = [{
                    id: crypto.randomUUID(),
                    name: 'Ali Khan',
                    phone: '03001234567',
                    email: 'ali.khan@example.com',
                    address: 'Street 5, Sector G-8, Islamabad',
                    isActive: true
                }, {
                    id: crypto.randomUUID(),
                    name: 'Sara Ahmed',
                    phone: '03337654321',
                    email: 'sara.ahmed@example.com',
                    address: 'House 12, Gulberg III, Lahore',
                    isActive: true
                }, {
                    id: crypto.randomUUID(),
                    name: 'Usman Tariq',
                    phone: '03219876543',
                    email: 'usman.tariq@example.com',
                    address: 'Block A, DHA Phase V, Karachi',
                    isActive: true
                }, {
                    id: crypto.randomUUID(),
                    name: 'Fatima Zohra',
                    phone: '03451122334',
                    email: 'fatima.z@example.com',
                    address: 'Apartment 7, F-10 Markaz, Islamabad',
                    isActive: false // Inactive customer
                }];

                const sampleSuppliers = [{
                    id: crypto.randomUUID(),
                    name: 'ABC Publishers',
                    contactPerson: 'Zain Ali',
                    phone: '021-34567890',
                    email: 'info@abcpubs.com',
                    address: 'D-34, Main Boulevard, Karachi'
                }, {
                    id: crypto.randomUUID(),
                    name: 'Global Books Distributors',
                    contactPerson: 'Maria Khan',
                    phone: '042-12345678',
                    email: 'sales@globalbooks.pk',
                    address: 'Model Town, Lahore'
                }, {
                    id: crypto.randomUUID(),
                    name: 'Local Importers',
                    contactPerson: 'Ahmed Raza',
                    phone: '051-98765432',
                    email: 'contact@localimporters.com',
                    address: 'I-8 Markaz, Islamabad'
                }, {
                    id: crypto.randomUUID(),
                    name: 'Book Hub Pvt Ltd',
                    contactPerson: 'Hassan Iqbal',
                    phone: '051-5432109',
                    email: 'hassan@bookhub.pk',
                    address: 'Blue Area, Islamabad'
                }];

                const book1 = sampleBooks[0]; // The Alchemist
                const book2 = sampleBooks[1]; // Sapiens
                const book3 = sampleBooks[4]; // Rich Dad Poor Dad
                const book4 = sampleBooks[3]; // 1984
                const customer1 = sampleCustomers[0]; // Ali Khan
                const customer2 = sampleCustomers[1]; // Sara Ahmed

                const sale1Items = [{
                    bookId: book1.id,
                    title: book1.title,
                    price: book1.price,
                    quantity: 1,
                    discount: 0
                }, {
                    bookId: book2.id,
                    title: book2.title,
                    price: book2.price,
                    quantity: 1,
                    discount: 0
                }];
                const sale1Total = sale1Items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const sale2Items = [{
                    bookId: book3.id,
                    title: book3.title,
                    price: book3.price,
                    quantity: 2,
                    discount: 0
                }];
                const sale2Total = sale2Items.reduce((sum, item) => sum + (item.price * item.quantity), 0);


                const sampleSales = [{
                    id: crypto.randomUUID(),
                    timestamp: Date.now() - (2 * 24 * 60 * 60 * 1000), // 2 days ago
                    customerId: customer1.id,
                    customerName: customer1.name,
                    items: sale1Items,
                    total: sale1Total,
                    subtotal: sale1Total,
                    discount: 0
                }, {
                    id: crypto.randomUUID(),
                    timestamp: Date.now() - (10 * 24 * 60 * 60 * 1000), // 10 days ago
                    customerId: customer2.id,
                    customerName: customer2.name,
                    items: sale2Items,
                    total: sale2Total,
                    subtotal: sale2Total,
                    discount: 0
                }, {
                    id: crypto.randomUUID(),
                    timestamp: Date.now() - (15 * 24 * 60 * 60 * 1000), // 15 days ago (guest sale)
                    customerId: null,
                    customerName: 'Guest',
                    items: [{
                        bookId: book4.id,
                        title: book4.title,
                        price: book4.price,
                        quantity: 1,
                        discount: 0
                    }],
                    total: book4.price,
                    subtotal: book4.price,
                    discount: 0
                }, {
                    id: crypto.randomUUID(),
                    timestamp: Date.now(), // Today's sale
                    customerId: customer1.id,
                    customerName: customer1.name,
                    items: [{
                        bookId: sampleBooks[2].id,
                        title: sampleBooks[2].title,
                        price: sampleBooks[2].price,
                        quantity: 1,
                        discount: 0
                    }],
                    total: sampleBooks[2].price,
                    subtotal: sampleBooks[2].price,
                    discount: 0
                }];

                const supplier1 = sampleSuppliers[0];
                const bookFromSupplier1 = sampleBooks[5]; // To Kill a Mockingbird

                const samplePOs = [{
                    id: crypto.randomUUID().substring(0, 8).toUpperCase(),
                    supplierId: supplier1.id,
                    supplierName: supplier1.name,
                    orderDate: new Date(Date.now() - (7 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    expectedDate: new Date(Date.now() + (7 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    status: 'ordered',
                    items: [{
                        bookId: bookFromSupplier1.id,
                        title: bookFromSupplier1.title,
                        quantity: 10,
                        unitCost: bookFromSupplier1.price * 0.7 // Assuming 30% discount from supplier
                    }, {
                        bookId: sampleBooks[0].id,
                        title: sampleBooks[0].title,
                        quantity: 5,
                        unitCost: sampleBooks[0].price * 0.7
                    }],
                    totalCost: 10 * (bookFromSupplier1.price * 0.7) + 5 * (sampleBooks[0].price * 0.7)
                }, {
                    id: crypto.randomUUID().substring(0, 8).toUpperCase(),
                    supplierId: sampleSuppliers[1].id,
                    supplierName: sampleSuppliers[1].name,
                    orderDate: new Date(Date.now() - (30 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    expectedDate: new Date(Date.now() - (20 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    status: 'received',
                    items: [{
                        bookId: sampleBooks[3].id,
                        title: sampleBooks[3].title,
                        quantity: 15,
                        unitCost: sampleBooks[3].price * 0.6
                    }],
                    totalCost: 15 * (sampleBooks[3].price * 0.6)
                }];

                const sampleExpenses = [{
                    id: crypto.randomUUID(),
                    date: new Date(Date.now() - (3 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    category: 'Utilities',
                    description: 'Electricity bill for July',
                    amount: 8500.00
                }, {
                    id: crypto.randomUUID(),
                    date: new Date(Date.now() - (15 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    category: 'Rent',
                    description: 'Monthly shop rent',
                    amount: 50000.00
                }, {
                    id: crypto.randomUUID(),
                    date: new Date(Date.now() - (20 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    category: 'Supplies',
                    description: 'Office stationery and packing material',
                    amount: 3200.00
                }, {
                    id: crypto.randomUUID(),
                    date: new Date().toISOString().split('T')[0],
                    category: 'Marketing',
                    description: 'Social media ad campaign for new releases',
                    amount: 15000.00
                }];


                for (const book of sampleBooks) {
                    await addData(OBJECT_STORES.BOOKS, book);
                }
                for (const customer of sampleCustomers) {
                    await addData(OBJECT_STORES.CUSTOMERS, customer);
                }
                for (const supplier of sampleSuppliers) {
                    await addData(OBJECT_STORES.SUPPLIERS, supplier);
                }
                for (const po of samplePOs) {
                    await addData(OBJECT_STORES.PURCHASE_ORDERS, po);
                }
                for (const sale of sampleSales) {
                    await addData(OBJECT_STORES.SALES, sale);
                }
                for (const expense of sampleExpenses) {
                    await addData(OBJECT_STORES.EXPENSES, expense);
                }

                showToast('Sample data added to the database!', 'info');
                await renderAll(currentPage);
            }
        }

        async function addData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function getData(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function getAllData(storeName, index = null, query = null) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                let request;
                if (index && query) {
                    request = store.index(index).getAll(query);
                } else {
                    request = store.getAll();
                }

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function updateData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function deleteData(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve(true);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();

                request.onsuccess = () => resolve(true);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function showPage(pageId) {
            elements.pageContents.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            elements.navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${pageId}`) {
                    link.classList.add('active');
                }
            });

            currentPage = pageId;
            if (elements.sidebar.classList.contains('active')) {
                elements.sidebar.classList.remove('active');
            }

            await renderAll(currentPage);
        }

        async function renderAll(pageId) {
            if (!db) return;

            // Always update dashboard stats
            await updateDashboard();

            // Render specific page content
            if (pageId === 'books') {
                await renderBooks();
            } else if (pageId === 'customers') {
                await renderCustomers();
            } else if (pageId === 'suppliers') {
                await renderSuppliers();
            } else if (pageId === 'purchase-orders') {
                await renderPurchaseOrders();
            } else if (pageId === 'cart') {
                await renderBooksForCart();
                renderCart();
            } else if (pageId === 'promotions') {
                await renderPromotions();
            } else if (pageId === 'expenses') {
                await renderExpenses();
            } else if (pageId === 'sales-history') {
                await renderSalesHistory();
            } else if (pageId === 'reports') {
                updateReportFilters();
                elements.reportResultsTable.querySelector('tbody').innerHTML = `<tr><td colspan="3">Select a report type and generate to see results.</td></tr>`;
                currentReportData = [];
                elements.exportCurrentReportBtn.disabled = true;
                if (reportChartInstance) {
                    reportChartInstance.destroy();
                    reportChartInstance = null;
                }
            }
        }

        function updatePaginationControls(paginationConfig, totalItems) {
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            paginationConfig.totalPages = totalPages === 0 ? 1 : totalPages;
            paginationConfig.currentPage = Math.min(paginationConfig.currentPage, paginationConfig.totalPages);
            if (paginationConfig.currentPage < 1) paginationConfig.currentPage = 1;


            paginationConfig.elements.info.textContent = `Page ${paginationConfig.currentPage} of ${paginationConfig.totalPages}`;
            paginationConfig.elements.prev.disabled = paginationConfig.currentPage === 1;
            paginationConfig.elements.next.disabled = paginationConfig.currentPage === paginationConfig.totalPages;
        }

        async function updateDashboard() {
            const books = await getAllData(OBJECT_STORES.BOOKS);
            const customers = await getAllData(OBJECT_STORES.CUSTOMERS);
            const sales = await getAllData(OBJECT_STORES.SALES);

            elements.totalBooksCount.textContent = books.length;
            elements.totalCustomersCount.textContent = customers.filter(c => c.isActive).length;

            const lowStockBooks = books.filter(book => book.stock < 5);
            elements.lowStockCount.textContent = lowStockBooks.length;
            elements.lowStockCount.classList.toggle('danger', lowStockBooks.length > 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todaySales = sales.filter(sale => new Date(sale.timestamp).setHours(0, 0, 0, 0) === today.getTime());
            const todaySalesTotal = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            elements.todaySalesTotal.textContent = formatCurrency(todaySalesTotal);

            const recentSales = sales.sort((a, b) => b.timestamp - a.timestamp).slice(0, 5);
            elements.dashboardRecentSales.innerHTML = recentSales.length > 0 ? recentSales.map(sale => `
                <tr>
                    <td>${formatDate(sale.timestamp)}</td>
                    <td>${sale.customerName || 'Guest'}</td>
                    <td>${sale.items.length} items</td>
                    <td>${formatCurrency(sale.total)}</td>
                </tr>
            `).join('') : `<tr><td colspan="4">No recent sales.</td></tr>`;

            elements.dashboardLowStockBooks.innerHTML = lowStockBooks.length > 0 ? lowStockBooks.map(book => `
                <tr class="${book.stock < 5 ? 'low-stock' : ''}">
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.stock}</td>
                    <td class="actions">
                        <button class="btn btn-info btn-sm" onclick="openRestockModal('${book.id}')"><i class="fas fa-box"></i> Restock</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="4">No books currently low in stock.</td></tr>`;
        }

        async function renderBooks() {
            let books = await getAllData(OBJECT_STORES.BOOKS);
            const searchTerm = elements.bookSearch.value.toLowerCase();
            const sortBy = elements.bookSort.value;

            if (searchTerm) {
                books = books.filter(book =>
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    book.isbn.toLowerCase().includes(searchTerm) ||
                    book.category.toLowerCase().includes(searchTerm)
                );
            }

            switch (sortBy) {
                case 'title-asc':
                    books.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'title-desc':
                    books.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'price-asc':
                    books.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    books.sort((a, b) => b.price - a.price);
                    break;
                case 'stock-asc':
                    books.sort((a, b) => a.stock - b.stock);
                    break;
                case 'stock-desc':
                    books.sort((a, b) => b.stock - a.stock);
                    break;
            }

            updatePaginationControls(pagination.books, books.length);
            const startIndex = (pagination.books.currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const paginatedBooks = books.slice(startIndex, endIndex);

            elements.booksList.innerHTML = paginatedBooks.length > 0 ? paginatedBooks.map(book => `
                <tr class="${book.stock < 5 ? 'low-stock' : ''}">
                    <td>${book.coverImage ? `<img src="${book.coverImage}" alt="Cover" width="50" height="70" style="object-fit: cover; border-radius: 3px;">` : '<i class="fas fa-book-open fa-2x" style="color: var(--light-text-color);"></i>'}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.category}</td>
                    <td>${book.isbn}</td>
                    <td>${formatCurrency(book.price)}</td>
                    <td>${book.stock}</td>
                    <td class="actions">
                        <button class="btn btn-info btn-sm" onclick="openRestockModal('${book.id}')"><i class="fas fa-box"></i> Restock</button>
                        <button class="btn btn-primary btn-sm" onclick="openBookModal('${book.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteBook('${book.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="8">No books found.</td></tr>`;
        }

        async function openBookModal(bookId = null) {
            elements.bookForm.reset();
            elements.bookId.value = '';
            elements.bookModalTitle.textContent = 'Add New Book';
            elements.bookCoverPreview.style.display = 'none';
            elements.bookCoverPreview.src = '';
            elements.bookCoverImage.value = '';

            if (bookId) {
                const book = await getData(OBJECT_STORES.BOOKS, bookId);
                if (book) {
                    elements.bookModalTitle.textContent = 'Edit Book';
                    elements.bookId.value = book.id;
                    elements.bookTitle.value = book.title;
                    elements.bookAuthor.value = book.author;
                    elements.bookCategory.value = book.category;
                    elements.bookIsbn.value = book.isbn;
                    elements.bookPublisher.value = book.publisher;
                    elements.bookYear.value = book.year;
                    elements.bookPrice.value = book.price;
                    elements.bookStock.value = book.stock;
                    elements.bookDescription.value = book.description;
                    if (book.coverImage) {
                        elements.bookCoverPreview.src = book.coverImage;
                        elements.bookCoverPreview.style.display = 'block';
                    }
                }
            }
            showModal(elements.bookModal);
        }

        async function saveBook(event) {
            event.preventDefault();

            const price = parseFloat(elements.bookPrice.value);
            const stock = parseInt(elements.bookStock.value);

            if (price < 0) {
                showToast('Price cannot be negative.', 'error');
                return;
            }
            if (stock < 0) {
                showToast('Stock quantity cannot be negative.', 'error');
                return;
            }

            const bookId = elements.bookId.value || crypto.randomUUID();
            const coverImageFile = elements.bookCoverImage.files[0];
            let coverImageBase64 = '';

            if (coverImageFile) {
                try {
                    coverImageBase64 = await readFileAsBase64(coverImageFile);
                } catch (error) {
                    showToast('Failed to read image file.', 'error');
                    return;
                }
            } else if (elements.bookCoverPreview.src && elements.bookCoverPreview.src.startsWith('data:image')) {
                coverImageBase64 = elements.bookCoverPreview.src;
            }

            const book = {
                id: bookId,
                title: elements.bookTitle.value,
                author: elements.bookAuthor.value,
                category: elements.bookCategory.value,
                isbn: elements.bookIsbn.value,
                publisher: elements.bookPublisher.value,
                year: parseInt(elements.bookYear.value) || null,
                price: price,
                stock: stock,
                description: elements.bookDescription.value,
                coverImage: coverImageBase64
            };

            try {
                if (elements.bookId.value) {
                    await updateData(OBJECT_STORES.BOOKS, book);
                    showToast('Book updated successfully!', 'success');
                } else {
                    await addData(OBJECT_STORES.BOOKS, book);
                    showToast('Book added successfully!', 'success');
                }
                hideModal(elements.bookModal);
                await renderBooks();
                await updateDashboard();
            } catch (error) {
                console.error('Failed to save book:', error);
                if (error.name === 'ConstraintError') {
                    showToast('ISBN must be unique. A book with this ISBN already exists.', 'error');
                } else {
                    showToast(`Failed to save book: ${error.message || error}`, 'error');
                }
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function deleteBook(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) return;
            try {
                await deleteData(OBJECT_STORES.BOOKS, bookId);
                showToast('Book deleted successfully!', 'success');
                await renderBooks();
                await updateDashboard();
            } catch (error) {
                console.error('Failed to delete book:', error);
                showToast('Failed to delete book.', 'error');
            }
        }

        async function openRestockModal(bookId) {
            const book = await getData(OBJECT_STORES.BOOKS, bookId);
            if (book) {
                elements.restockBookId.value = book.id;
                elements.restockBookTitle.value = book.title;
                elements.restockCurrentStock.value = book.stock;
                elements.restockQuantity.value = 1;
                showModal(elements.restockModal);
            }
        }

        async function restockBook(event) {
            event.preventDefault();
            const bookId = elements.restockBookId.value;
            const quantityToAdd = parseInt(elements.restockQuantity.value);

            if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                showToast('Please enter a valid quantity.', 'error');
                return;
            }

            try {
                const book = await getData(OBJECT_STORES.BOOKS, bookId);
                if (book) {
                    book.stock += quantityToAdd;
                    await updateData(OBJECT_STORES.BOOKS, book);
                    showToast(`Book "${book.title}" restocked successfully! New stock: ${book.stock}`, 'success');
                    hideModal(elements.restockModal);
                    await renderBooks();
                    await updateDashboard();
                    if (currentPage === 'cart') {
                        await renderBooksForCart();
                    }
                }
            } catch (error) {
                console.error('Failed to restock book:', error);
                showToast('Failed to restock book.', 'error');
            }
        }

        async function renderCustomers() {
            let customers = await getAllData(OBJECT_STORES.CUSTOMERS);
            const searchTerm = elements.customerSearch.value.toLowerCase();
            const statusFilter = elements.customerFilterStatus.value;

            if (searchTerm) {
                customers = customers.filter(customer =>
                    customer.name.toLowerCase().includes(searchTerm) ||
                    (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                    (customer.phone && customer.phone.toLowerCase().includes(searchTerm))
                );
            }

            if (statusFilter !== 'all') {
                const isActive = statusFilter === 'active';
                customers = customers.filter(customer => customer.isActive === isActive);
            }

            customers.sort((a, b) => a.name.localeCompare(b.name));

            updatePaginationControls(pagination.customers, customers.length);
            const startIndex = (pagination.customers.currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const paginatedCustomers = customers.slice(startIndex, endIndex);

            elements.customersList.innerHTML = paginatedCustomers.length > 0 ? paginatedCustomers.map(customer => `
                <tr class="${!customer.isActive ? 'inactive-customer' : ''}">
                    <td>${customer.name}</td>
                    <td>${customer.phone || 'N/A'}</td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.address || 'N/A'}</td>
                    <td>${customer.isActive ? 'Active' : 'Inactive'}</td>
                    <td class="actions">
                        <button class="btn btn-info btn-sm" onclick="viewCustomerHistory('${customer.id}', '${customer.name}')"><i class="fas fa-history"></i> History</button>
                        <button class="btn btn-primary btn-sm" onclick="openCustomerModal('${customer.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn ${customer.isActive ? 'btn-danger' : 'btn-success'} btn-sm" onclick="toggleCustomerStatus('${customer.id}', ${customer.isActive})"><i class="fas ${customer.isActive ? 'fa-user-slash' : 'fa-user-check'}"></i> ${customer.isActive ? 'Deactivate' : 'Activate'}</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="6">No customers found.</td></tr>`;
        }

        async function openCustomerModal(customerId = null) {
            elements.customerForm.reset();
            elements.customerId.value = '';
            elements.customerModalTitle.textContent = 'Add New Customer';

            if (customerId) {
                const customer = await getData(OBJECT_STORES.CUSTOMERS, customerId);
                if (customer) {
                    elements.customerModalTitle.textContent = 'Edit Customer';
                    elements.customerId.value = customer.id;
                    elements.customerName.value = customer.name;
                    elements.customerPhone.value = customer.phone;
                    elements.customerEmail.value = customer.email;
                    elements.customerAddress.value = customer.address;
                }
            }
            showModal(elements.customerModal);
        }

        async function saveCustomer(event) {
            event.preventDefault();
            const customerId = elements.customerId.value || crypto.randomUUID();
            const email = elements.customerEmail.value;

            if (email) {
                const existingCustomers = await getAllData(OBJECT_STORES.CUSTOMERS);
                const duplicateEmail = existingCustomers.find(c => c.email === email && c.id !== customerId);
                if (duplicateEmail) {
                    showToast('A customer with this email already exists.', 'error');
                    return;
                }
            }

            const customer = {
                id: customerId,
                name: elements.customerName.value,
                phone: elements.customerPhone.value,
                email: elements.customerEmail.value,
                address: elements.customerAddress.value,
                isActive: true
            };

            try {
                if (elements.customerId.value) {
                    // Preserve isActive status if editing
                    const existingCustomer = await getData(OBJECT_STORES.CUSTOMERS, customerId);
                    customer.isActive = existingCustomer.isActive;
                    await updateData(OBJECT_STORES.CUSTOMERS, customer);
                    showToast('Customer updated successfully!', 'success');
                } else {
                    await addData(OBJECT_STORES.CUSTOMERS, customer);
                    showToast('Customer added successfully!', 'success');
                }
                hideModal(elements.customerModal);
                await renderCustomers();
                await updateDashboard();
            } catch (error) {
                console.error('Failed to save customer:', error);
                showToast(`Failed to save customer: ${error.message || error}`, 'error');
            }
        }

        async function toggleCustomerStatus(customerId, currentStatus) {
            const customer = await getData(OBJECT_STORES.CUSTOMERS, customerId);
            if (customer) {
                customer.isActive = !currentStatus;
                await updateData(OBJECT_STORES.CUSTOMERS, customer);
                showToast(`Customer "${customer.name}" status updated to ${customer.isActive ? 'Active' : 'Inactive'}.`, 'info');
                await renderCustomers();
                await updateDashboard();
            }
        }

        async function viewCustomerHistory(customerId, customerName) {
            elements.customerHistoryTitle.textContent = `Purchase History for ${customerName}`;
            const sales = await getAllData(OBJECT_STORES.SALES);
            const customerSales = sales.filter(sale => sale.customerId === customerId)
                .sort((a, b) => b.timestamp - a.timestamp);

            elements.customerHistoryList.innerHTML = customerSales.length > 0 ? customerSales.map(sale => `
                <tr>
                    <td>${sale.id.substring(0, 8)}...</td>
                    <td>${formatDate(sale.timestamp)}</td>
                    <td>${sale.items.map(item => `${item.title} (${item.quantity})`).join(', ')}</td>
                    <td>${formatCurrency(sale.total)}</td>
                </tr>
            `).join('') : `<tr><td colspan="4">No purchases found for this customer.</td></tr>`;
            showModal(elements.customerHistoryModal);
        }

        async function renderSuppliers() {
            let suppliers = await getAllData(OBJECT_STORES.SUPPLIERS);
            const searchTerm = elements.supplierSearch.value.toLowerCase();

            if (searchTerm) {
                suppliers = suppliers.filter(supplier =>
                    supplier.name.toLowerCase().includes(searchTerm) ||
                    (supplier.contactPerson && supplier.contactPerson.toLowerCase().includes(searchTerm)) ||
                    (supplier.email && supplier.email.toLowerCase().includes(searchTerm)) ||
                    (supplier.phone && supplier.phone.toLowerCase().includes(searchTerm))
                );
            }
            suppliers.sort((a, b) => a.name.localeCompare(b.name));

            updatePaginationControls(pagination.suppliers, suppliers.length);
            const startIndex = (pagination.suppliers.currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const paginatedSuppliers = suppliers.slice(startIndex, endIndex);

            elements.suppliersList.innerHTML = paginatedSuppliers.length > 0 ? paginatedSuppliers.map(supplier => `
                <tr>
                    <td>${supplier.name}</td>
                    <td>${supplier.contactPerson || 'N/A'}</td>
                    <td>${supplier.phone || 'N/A'}</td>
                    <td>${supplier.email || 'N/A'}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="openSupplierModal('${supplier.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSupplier('${supplier.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="5">No suppliers found.</td></tr>`;
        }

        async function openSupplierModal(supplierId = null) {
            elements.supplierForm.reset();
            elements.supplierId.value = '';
            elements.supplierModalTitle.textContent = 'Add New Supplier';

            if (supplierId) {
                const supplier = await getData(OBJECT_STORES.SUPPLIERS, supplierId);
                if (supplier) {
                    elements.supplierModalTitle.textContent = 'Edit Supplier';
                    elements.supplierId.value = supplier.id;
                    elements.supplierName.value = supplier.name;
                    elements.supplierContactPerson.value = supplier.contactPerson;
                    elements.supplierPhone.value = supplier.phone;
                    elements.supplierEmail.value = supplier.email;
                    elements.supplierAddress.value = supplier.address;
                }
            }
            showModal(elements.supplierModal);
        }

        async function saveSupplier(event) {
            event.preventDefault();
            const supplierId = elements.supplierId.value || crypto.randomUUID();
            const email = elements.supplierEmail.value;

            if (email) {
                const existingSuppliers = await getAllData(OBJECT_STORES.SUPPLIERS);
                const duplicateEmail = existingSuppliers.find(s => s.email === email && s.id !== supplierId);
                if (duplicateEmail) {
                    showToast('A supplier with this email already exists.', 'error');
                    return;
                }
            }

            const supplier = {
                id: supplierId,
                name: elements.supplierName.value,
                contactPerson: elements.supplierContactPerson.value,
                phone: elements.supplierPhone.value,
                email: elements.supplierEmail.value,
                address: elements.supplierAddress.value
            };

            try {
                if (elements.supplierId.value) {
                    await updateData(OBJECT_STORES.SUPPLIERS, supplier);
                    showToast('Supplier updated successfully!', 'success');
                } else {
                    await addData(OBJECT_STORES.SUPPLIERS, supplier);
                    showToast('Supplier added successfully!', 'success');
                }
                hideModal(elements.supplierModal);
                await renderSuppliers();
                await populatePoSuppliers(); // Update PO modal supplier list
            } catch (error) {
                console.error('Failed to save supplier:', error);
                showToast(`Failed to save supplier: ${error.message || error}`, 'error');
            }
        }

        async function deleteSupplier(supplierId) {
            if (!confirm('Are you sure you want to delete this supplier? This action cannot be undone.')) return;
            try {
                // Consider checking for existing POs associated with this supplier
                const relatedPOs = await getAllData(OBJECT_STORES.PURCHASE_ORDERS, 'supplierId', supplierId);
                if (relatedPOs.length > 0) {
                    showToast('Cannot delete supplier with active or historical purchase orders. Please delete related POs first.', 'error');
                    return;
                }
                await deleteData(OBJECT_STORES.SUPPLIERS, supplierId);
                showToast('Supplier deleted successfully!', 'success');
                await renderSuppliers();
                await populatePoSuppliers();
            } catch (error) {
                console.error('Failed to delete supplier:', error);
                showToast('Failed to delete supplier.', 'error');
            }
        }

        async function populatePoSuppliers() {
            const suppliers = await getAllData(OBJECT_STORES.SUPPLIERS);
            elements.poSupplier.innerHTML = suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            if (suppliers.length === 0) {
                elements.poSupplier.innerHTML = `<option value="">No Suppliers Available</option>`;
                elements.poForm.querySelector('button[type="submit"]').disabled = true;
                elements.poBookSearch.disabled = true;
            } else {
                elements.poForm.querySelector('button[type="submit"]').disabled = false;
                elements.poBookSearch.disabled = false;
            }
        }

        let currentPoItems = [];

        async function renderPurchaseOrders() {
            let purchaseOrders = await getAllData(OBJECT_STORES.PURCHASE_ORDERS);
            const searchTerm = elements.poSearch.value.toLowerCase();
            const statusFilter = elements.poStatusFilter.value;

            if (searchTerm) {
                purchaseOrders = purchaseOrders.filter(po =>
                    po.id.toLowerCase().includes(searchTerm) ||
                    po.supplierName.toLowerCase().includes(searchTerm) ||
                    po.status.toLowerCase().includes(searchTerm) ||
                    po.items.some(item => item.title.toLowerCase().includes(searchTerm))
                );
            }

            if (statusFilter !== 'all') {
                purchaseOrders = purchaseOrders.filter(po => po.status === statusFilter);
            }

            purchaseOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            updatePaginationControls(pagination.purchaseOrders, purchaseOrders.length);
            const startIndex = (pagination.purchaseOrders.currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const paginatedPOs = purchaseOrders.slice(startIndex, endIndex);

            elements.purchaseOrdersList.innerHTML = paginatedPOs.length > 0 ? paginatedPOs.map(po => `
                <tr>
                    <td>${po.id}</td>
                    <td>${po.supplierName}</td>
                    <td>${formatShortDate(new Date(po.orderDate))}</td>
                    <td>${po.expectedDate ? formatShortDate(new Date(po.expectedDate)) : 'N/A'}</td>
                    <td>${po.status.charAt(0).toUpperCase() + po.status.slice(1)}</td>
                    <td>${po.items.reduce((sum, item) => sum + item.quantity, 0)}</td>
                    <td>${formatCurrency(po.totalCost)}</td>
                    <td class="actions">
                        <button class="btn btn-info btn-sm" onclick="openPurchaseOrderModal('${po.id}')"><i class="fas fa-eye"></i> View/Edit</button>
                        ${po.status !== 'received' && po.status !== 'cancelled' ? `<button class="btn btn-success btn-sm" onclick="confirmReceivePurchaseOrder('${po.id}')"><i class="fas fa-truck-loading"></i> Receive</button>` : ''}
                        <button class="btn btn-danger btn-sm" onclick="deletePurchaseOrder('${po.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="8">No purchase orders found.</td></tr>`;
        }

        async function openPurchaseOrderModal(poId = null) {
            elements.poForm.reset();
            elements.poId.value = '';
            elements.poModalTitle.textContent = 'Create New Purchase Order';
            elements.poOrderDate.value = new Date().toISOString().split('T')[0];
            elements.poExpectedDate.value = '';
            elements.poStatus.value = 'pending';
            elements.poBookSearch.value = '';
            elements.poBookSearchResults.innerHTML = '';
            currentPoItems = [];
            renderPoItems();
            elements.receivePoBtn.style.display = 'none';

            await populatePoSuppliers();

            if (poId) {
                const po = await getData(OBJECT_STORES.PURCHASE_ORDERS, poId);
                if (po) {
                    elements.poModalTitle.textContent = 'Edit Purchase Order';
                    elements.poId.value = po.id;
                    elements.poSupplier.value = po.supplierId;
                    elements.poOrderDate.value = po.orderDate;
                    elements.poExpectedDate.value = po.expectedDate || '';
                    elements.poStatus.value = po.status;
                    currentPoItems = JSON.parse(JSON.stringify(po.items));
                    renderPoItems();
                    if (po.status === 'ordered') {
                        elements.receivePoBtn.style.display = 'inline-flex';
                        elements.receivePoBtn.onclick = () => confirmReceivePurchaseOrder(po.id);
                    } else {
                        elements.receivePoBtn.style.display = 'none';
                    }
                }
            }
            showModal(elements.purchaseOrderModal);
        }

        async function savePurchaseOrder(event) {
            event.preventDefault();
            if (currentPoItems.length === 0) {
                showToast('Purchase order must have at least one item.', 'error');
                return;
            }

            const poId = elements.poId.value || crypto.randomUUID().substring(0, 8).toUpperCase();
            const supplierId = elements.poSupplier.value;
            const supplierName = elements.poSupplier.options[elements.poSupplier.selectedIndex].text;
            const totalCost = currentPoItems.reduce((sum, item) => sum + (item.quantity * item.unitCost), 0);

            const purchaseOrder = {
                id: poId,
                supplierId: supplierId,
                supplierName: supplierName,
                orderDate: elements.poOrderDate.value,
                expectedDate: elements.poExpectedDate.value || null,
                status: elements.poStatus.value,
                items: currentPoItems,
                totalCost: totalCost
            };

            try {
                if (elements.poId.value) {
                    await updateData(OBJECT_STORES.PURCHASE_ORDERS, purchaseOrder);
                    showToast('Purchase Order updated successfully!', 'success');
                } else {
                    await addData(OBJECT_STORES.PURCHASE_ORDERS, purchaseOrder);
                    showToast('Purchase Order created successfully!', 'success');
                }
                hideModal(elements.purchaseOrderModal);
                await renderPurchaseOrders();
            } catch (error) {
                console.error('Failed to save purchase order:', error);
                showToast(`Failed to save purchase order: ${error.message || error}`, 'error');
            }
        }

        async function confirmReceivePurchaseOrder(poId) {
            if (!confirm('Are you sure you want to mark this Purchase Order as "Received" and update book stock?')) return;
            try {
                const po = await getData(OBJECT_STORES.PURCHASE_ORDERS, poId);
                if (po && po.status !== 'received') {
                    const transaction = db.transaction([OBJECT_STORES.BOOKS, OBJECT_STORES.PURCHASE_ORDERS], 'readwrite');
                    const bookStore = transaction.objectStore(OBJECT_STORES.BOOKS);
                    const poStore = transaction.objectStore(OBJECT_STORES.PURCHASE_ORDERS);

                    for (const item of po.items) {
                        const book = await new Promise((resolve, reject) => {
                            const req = bookStore.get(item.bookId);
                            req.onsuccess = () => resolve(req.result);
                            req.onerror = () => reject(req.error);
                        });
                        if (book) {
                            book.stock += item.quantity;
                            bookStore.put(book);
                        } else {
                            // If book doesn't exist, log and continue, or add it as a new book if defined in PO
                            console.warn(`Book with ID ${item.bookId} not found during PO receipt. Stock not updated.`);
                            showToast(`Warning: Book "${item.title}" not found. Stock not updated.`, 'warning');
                        }
                    }

                    po.status = 'received';
                    poStore.put(po);

                    await new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                    });

                    showToast(`Purchase Order ${po.id} received and book stock updated!`, 'success');
                    hideModal(elements.purchaseOrderModal);
                    await renderPurchaseOrders();
                    await updateDashboard();
                }
            } catch (error) {
                console.error('Failed to receive purchase order:', error);
                showToast(`Failed to receive purchase order: ${error.message || error}`, 'error');
            }
        }

        async function deletePurchaseOrder(poId) {
            if (!confirm('Are you sure you want to delete this purchase order? This action cannot be undone.')) return;
            try {
                await deleteData(OBJECT_STORES.PURCHASE_ORDERS, poId);
                showToast('Purchase Order deleted successfully!', 'success');
                await renderPurchaseOrders();
            } catch (error) {
                console.error('Failed to delete purchase order:', error);
                showToast('Failed to delete purchase order.', 'error');
            }
        }

        async function searchBooksForPo(query) {
            elements.poBookSearchResults.innerHTML = '';
            if (query.length < 2) {
                return;
            }
            const books = await getAllData(OBJECT_STORES.BOOKS);
            const filteredBooks = books.filter(book =>
                book.title.toLowerCase().includes(query.toLowerCase()) ||
                book.author.toLowerCase().includes(query.toLowerCase()) ||
                book.isbn.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5); // Limit to 5 results

            filteredBooks.forEach(book => {
                const div = document.createElement('div');
                div.textContent = `${book.title} by ${book.author} (ISBN: ${book.isbn})`;
                div.onclick = () => addPoItem(book);
                elements.poBookSearchResults.appendChild(div);
            });
        }

        function addPoItem(book) {
            const existingItem = currentPoItems.find(item => item.bookId === book.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentPoItems.push({
                    bookId: book.id,
                    title: book.title,
                    quantity: 1,
                    unitCost: book.price * 0.7, // Default 30% discount for POs
                    originalPrice: book.price // Store for reference
                });
            }
            elements.poBookSearch.value = '';
            elements.poBookSearchResults.innerHTML = '';
            renderPoItems();
        }

        function updatePoItemQuantity(bookId, quantity) {
            const itemIndex = currentPoItems.findIndex(item => item.bookId === bookId);
            if (itemIndex > -1) {
                currentPoItems[itemIndex].quantity = Math.max(1, quantity);
                renderPoItems();
            }
        }

        function updatePoItemCost(bookId, cost) {
            const itemIndex = currentPoItems.findIndex(item => item.bookId === bookId);
            if (itemIndex > -1) {
                currentPoItems[itemIndex].unitCost = Math.max(0, cost);
                renderPoItems();
            }
        }

        function removePoItem(bookId) {
            currentPoItems = currentPoItems.filter(item => item.bookId !== bookId);
            renderPoItems();
        }

        function renderPoItems() {
            let totalCost = 0;
            if (currentPoItems.length === 0) {
                elements.poItemsList.innerHTML = `<tr><td colspan="5">No items added to this purchase order.</td></tr>`;
            } else {
                elements.poItemsList.innerHTML = currentPoItems.map(item => {
                    const subtotal = item.quantity * item.unitCost;
                    totalCost += subtotal;
                    return `
                        <tr>
                            <td>${item.title}</td>
                            <td><input type="number" min="1" value="${item.quantity}" onchange="updatePoItemQuantity('${item.bookId}', parseInt(this.value))" style="width: 70px;"></td>
                            <td><input type="number" min="0" step="0.01" value="${item.unitCost.toFixed(2)}" onchange="updatePoItemCost('${item.bookId}', parseFloat(this.value))" style="width: 100px;"></td>
                            <td>${formatCurrency(subtotal)}</td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removePoItem('${item.bookId}')"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                }).join('');
            }
            elements.poGrandTotal.textContent = formatCurrency(totalCost);
        }

        async function renderBooksForCart() {
            let books = await getAllData(OBJECT_STORES.BOOKS);
            const searchTerm = elements.bookToCartSearch.value.toLowerCase();

            if (searchTerm) {
                books = books.filter(book =>
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    book.isbn.toLowerCase().includes(searchTerm)
                );
            }

            // Filter out books with 0 stock
            books = books.filter(book => book.stock > 0);

            updatePaginationControls(pagination.booksForCart, books.length);
            const startIndex = (pagination.booksForCart.currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const paginatedBooks = books.slice(startIndex, endIndex);

            elements.booksForCartList.innerHTML = paginatedBooks.length > 0 ? paginatedBooks.map(book => {
                const inCartQuantity = currentCart.find(item => item.bookId === book.id)?.quantity || 0;
                const availableStock = book.stock - inCartQuantity;
                return `
                    <tr>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${formatCurrency(book.price)}</td>
                        <td class="${availableStock < 5 && availableStock > 0 ? 'low-stock' : (availableStock <= 0 ? 'danger' : '')}">${availableStock}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="addToCart('${book.id}', '${book.title}', ${book.price})" ${availableStock <= 0 ? 'disabled' : ''}><i class="fas fa-cart-plus"></i> Add to Cart</button>
                        </td>
                    </tr>
                `;
            }).join('') : `<tr><td colspan="5">No books found to add to cart.</td></tr>`;
        }

        async function addToCart(bookId, title, price) {
            const book = await getData(OBJECT_STORES.BOOKS, bookId);
            if (!book) {
                showToast('Book not found in inventory.', 'error');
                return;
            }

            const existingItemIndex = currentCart.findIndex(item => item.bookId === bookId);
            const currentQuantityInCart = existingItemIndex > -1 ? currentCart[existingItemIndex].quantity : 0;

            if (currentQuantityInCart >= book.stock) {
                showToast(`Cannot add more "${title}". Only ${book.stock} available.`, 'warning');
                return;
            }

            if (existingItemIndex > -1) {
                currentCart[existingItemIndex].quantity++;
            } else {
                currentCart.push({
                    bookId,
                    title,
                    price,
                    quantity: 1,
                    discount: 0 // Individual item discount
                });
            }
            showToast(`"${title}" added to cart.`, 'info');
            renderCart();
            renderBooksForCart();
        }

        async function updateCartItemQuantity(bookId, newQuantity) {
            const book = await getData(OBJECT_STORES.BOOKS, bookId);
            if (!book) {
                showToast('Book not found in inventory.', 'error');
                return;
            }

            const itemIndex = currentCart.findIndex(item => item.bookId === bookId);
            if (itemIndex > -1) {
                if (newQuantity <= 0) {
                    removeCartItem(bookId);
                    return;
                }
                if (newQuantity > book.stock) {
                    showToast(`Cannot add more than available stock (${book.stock}) for "${book.title}".`, 'warning');
                    currentCart[itemIndex].quantity = book.stock;
                } else {
                    currentCart[itemIndex].quantity = newQuantity;
                }
                renderCart();
                renderBooksForCart();
            }
        }

        function removeCartItem(bookId) {
            currentCart = currentCart.filter(item => item.bookId !== bookId);
            showToast('Item removed from cart.', 'info');
            renderCart();
            renderBooksForCart();
        }

        function calculateCartTotals() {
            let subtotal = 0;
            currentCart.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            let totalDiscount = 0;
            let finalTotal = subtotal;

            if (appliedPromotion) {
                if (appliedPromotion.appliesTo === 'all') {
                    totalDiscount = appliedPromotion.type === 'percentage' ?
                        subtotal * (appliedPromotion.value / 100) :
                        appliedPromotion.value;
                    totalDiscount = Math.min(totalDiscount, subtotal); // Discount cannot exceed subtotal
                    finalTotal = subtotal - totalDiscount;
                } else if (appliedPromotion.appliesTo === 'specific-book') {
                    currentCart.forEach(item => {
                        if (item.bookId === appliedPromotion.appliesToValue) {
                            const itemPrice = item.price * item.quantity;
                            const discountAmount = appliedPromotion.type === 'percentage' ?
                                itemPrice * (appliedPromotion.value / 100) :
                                appliedPromotion.value;
                            item.discount = Math.min(discountAmount, itemPrice);
                            totalDiscount += item.discount;
                        } else {
                            item.discount = 0;
                        }
                    });
                    finalTotal = subtotal - totalDiscount;
                } else if (appliedPromotion.appliesTo === 'specific-category') {
                    currentCart.forEach(async (item) => {
                        const book = await getData(OBJECT_STORES.BOOKS, item.bookId);
                        if (book && book.category === appliedPromotion.appliesToValue) {
                            const itemPrice = item.price * item.quantity;
                            const discountAmount = appliedPromotion.type === 'percentage' ?
                                itemPrice * (appliedPromotion.value / 100) :
                                appliedPromotion.value;
                            item.discount = Math.min(discountAmount, itemPrice);
                            totalDiscount += item.discount;
                        } else {
                            item.discount = 0;
                        }
                    });
                    finalTotal = subtotal - totalDiscount;
                }
            } else {
                currentCart.forEach(item => item.discount = 0);
            }

            finalTotal = Math.max(0, finalTotal); // Final total cannot be negative

            return {
                subtotal: subtotal,
                discount: totalDiscount,
                total: finalTotal
            };
        }


        function renderCart() {
            const {
                subtotal,
                discount,
                total
            } = calculateCartTotals();

            elements.cartTotalItems.textContent = currentCart.reduce((sum, item) => sum + item.quantity, 0);

            if (currentCart.length === 0) {
                elements.cartItemsTable.innerHTML = `<tr><td colspan="6">Cart is empty.</td></tr>`;
                elements.clearCartBtn.disabled = true;
                elements.checkoutBtn.disabled = true;
                elements.checkoutPromotionCode.value = '';
                appliedPromotion = null;
            } else {
                elements.cartItemsTable.innerHTML = currentCart.map(item => {
                    const itemSubtotal = item.price * item.quantity;
                    const itemNetTotal = itemSubtotal - item.discount;
                    return `
                        <tr>
                            <td>${item.title}</td>
                            <td>${formatCurrency(item.price)}</td>
                            <td class="quantity-controls">
                                <button class="btn btn-secondary btn-sm" onclick="updateCartItemQuantity('${item.bookId}', ${item.quantity - 1})">-</button>
                                <input type="number" value="${item.quantity}" min="1" onchange="updateCartItemQuantity('${item.bookId}', parseInt(this.value))">
                                <button class="btn btn-secondary btn-sm" onclick="updateCartItemQuantity('${item.bookId}', ${item.quantity + 1})">+</button>
                            </td>
                            <td>${item.discount > 0 ? formatCurrency(item.discount) : 'N/A'}</td>
                            <td>${formatCurrency(itemNetTotal)}</td>
                            <td class="actions">
                                <button class="btn btn-danger btn-sm" onclick="removeCartItem('${item.bookId}')"><i class="fas fa-trash"></i> Remove</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                elements.clearCartBtn.disabled = false;
                elements.checkoutBtn.disabled = false;
            }
            elements.cartGrandTotal.textContent = formatCurrency(total);
            elements.checkoutSubtotal.value = formatCurrency(subtotal);
            elements.checkoutDiscount.value = formatCurrency(discount);
            elements.checkoutTotal.value = formatCurrency(total);
            elements.checkoutDiscountDisplay.style.display = discount > 0 ? 'block' : 'none';
        }

        async function openCheckoutModal() {
            if (currentCart.length === 0) {
                showToast('Cart is empty. Please add items to cart before checkout.', 'warning');
                return;
            }

            const customers = (await getAllData(OBJECT_STORES.CUSTOMERS)).filter(c => c.isActive);
            elements.checkoutCustomer.innerHTML = '<option value="">Guest Customer</option>' +
                customers.map(customer => `<option value="${customer.id}">${customer.name}</option>`).join('');

            renderCart(); // Recalculate and display current totals
            showModal(elements.checkoutModal);
        }

        async function applyPromotion() {
            const promoCode = elements.checkoutPromotionCode.value.trim();
            if (!promoCode) {
                appliedPromotion = null;
                renderCart();
                showToast('Promotion code cleared.', 'info');
                return;
            }

            const promotions = await getAllData(OBJECT_STORES.PROMOTIONS);
            const now = Date.now();
            const promotion = promotions.find(p =>
                p.code.toLowerCase() === promoCode.toLowerCase() &&
                new Date(p.startDate).getTime() <= now &&
                (!p.endDate || new Date(p.endDate).getTime() >= now)
            );

            if (promotion) {
                appliedPromotion = promotion;
                showToast(`Promotion "${promotion.code}" applied!`, 'success');
            } else {
                appliedPromotion = null;
                showToast('Invalid or expired promotion code.', 'error');
            }
            renderCart();
        }


        async function completeCheckout(event) {
            event.preventDefault();
            if (currentCart.length === 0) {
                showToast('Cart is empty, cannot complete checkout.', 'error');
                return;
            }

            const customerId = elements.checkoutCustomer.value;
            let customerName = 'Guest';
            if (customerId) {
                const customer = await getData(OBJECT_STORES.CUSTOMERS, customerId);
                if (customer) customerName = customer.name;
            }

            const transaction = db.transaction([OBJECT_STORES.BOOKS, OBJECT_STORES.SALES], 'readwrite');
            const bookStore = transaction.objectStore(OBJECT_STORES.BOOKS);
            const salesStore = transaction.objectStore(OBJECT_STORES.SALES);

            try {
                // Check stock before proceeding
                for (const cartItem of currentCart) {
                    const book = await new Promise((resolve, reject) => {
                        const req = bookStore.get(cartItem.bookId);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject(req.error);
                    });

                    if (!book || book.stock < cartItem.quantity) {
                        showToast(`Not enough stock for "${cartItem.title}". Available: ${book ? book.stock : 0}, Needed: ${cartItem.quantity}.`, 'error');
                        transaction.abort();
                        return;
                    }
                }

                // Deduct stock and add sale
                for (const cartItem of currentCart) {
                    const book = await new Promise((resolve, reject) => {
                        const req = bookStore.get(cartItem.bookId);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject(req.error);
                    });
                    book.stock -= cartItem.quantity;
                    bookStore.put(book);
                }

                const {
                    subtotal,
                    discount,
                    total
                } = calculateCartTotals();

                const saleRecord = {
                    id: crypto.randomUUID(),
                    timestamp: Date.now(),
                    customerId: customerId || null,
                    customerName: customerName,
                    items: JSON.parse(JSON.stringify(currentCart)), // Deep copy cart items including individual discounts
                    subtotal: subtotal,
                    discount: discount,
                    total: total,
                    promotionCode: appliedPromotion ? appliedPromotion.code : null
                };
                salesStore.add(saleRecord);

                await new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });

                showToast('Sale completed successfully!', 'success');
                hideModal(elements.checkoutModal);
                openReceiptModal(saleRecord);
                currentCart = [];
                appliedPromotion = null;
                elements.checkoutPromotionCode.value = '';
                await renderBooksForCart();
                renderCart();
                await updateDashboard();
                await renderBooks();
            } catch (error) {
                console.error('Checkout failed:', error);
                showToast(`Checkout failed: ${error.message || error}`, 'error');
            }
        }

        function clearCart() {
            if (confirm('Are you sure you want to clear the entire cart?')) {
                currentCart = [];
                appliedPromotion = null;
                elements.checkoutPromotionCode.value = '';
                renderCart();
                renderBooksForCart(); // Update stock availability in add-to-cart list
                showToast('Cart cleared.', 'info');
            }
        }

        async function renderPromotions() {
            const promotions = (await getAllData(OBJECT_STORES.PROMOTIONS)).sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            elements.promotionsList.innerHTML = promotions.length > 0 ? promotions.map(promo => `
                <tr>
                    <td>${promo.code}</td>
                    <td>${promo.type === 'percentage' ? 'Percentage Off' : 'Fixed Amount Off'}</td>
                    <td>${promo.type === 'percentage' ? `${promo.value}%` : formatCurrency(promo.value)}</td>
                    <td>${promo.appliesTo === 'all' ? 'Entire Order' : promo.appliesTo === 'specific-book' ? `Book: ${promo.appliesToValueTitle || promo.appliesToValue}` : `Category: ${promo.appliesToValue}`}</td>
                    <td>${formatShortDate(new Date(promo.startDate))}</td>
                    <td>${promo.endDate ? formatShortDate(new Date(promo.endDate)) : 'No End Date'}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="openPromotionModal('${promo.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePromotion('${promo.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="7">No promotions found.</td></tr>`;
        }

        async function openPromotionModal(promotionId = null) {
            elements.promotionForm.reset();
            elements.promotionId.value = '';
            elements.promotionModalTitle.textContent = 'Add New Promotion';
            elements.promotionType.value = 'percentage';
            elements.promotionTypePercentage.classList.add('active');
            elements.promotionTypeFixed.classList.remove('active');
            elements.promotionAppliesTo.value = 'all';
            elements.promotionBookGroup.style.display = 'none';
            elements.promotionCategoryGroup.style.display = 'none';

            const books = await getAllData(OBJECT_STORES.BOOKS);
            elements.promotionBookId.innerHTML = '<option value="">Select a Book</option>' +
                books.map(book => `<option value="${book.id}">${book.title} by ${book.author}</option>`).join('');

            const categories = [...new Set(books.map(book => book.category))];
            elements.bookCategoriesDatalist.innerHTML = categories.map(cat => `<option value="${cat}">`).join('');

            if (promotionId) {
                const promo = await getData(OBJECT_STORES.PROMOTIONS, promotionId);
                if (promo) {
                    elements.promotionModalTitle.textContent = 'Edit Promotion';
                    elements.promotionId.value = promo.id;
                    elements.promotionCode.value = promo.code;
                    elements.promotionType.value = promo.type;
                    if (promo.type === 'percentage') {
                        elements.promotionTypePercentage.classList.add('active');
                        elements.promotionTypeFixed.classList.remove('active');
                    } else {
                        elements.promotionTypeFixed.classList.add('active');
                        elements.promotionTypePercentage.classList.remove('active');
                    }
                    elements.promotionValue.value = promo.value;
                    elements.promotionAppliesTo.value = promo.appliesTo;
                    if (promo.appliesTo === 'specific-book') {
                        elements.promotionBookGroup.style.display = 'block';
                        elements.promotionBookId.value = promo.appliesToValue;
                    } else if (promo.appliesTo === 'specific-category') {
                        elements.promotionCategoryGroup.style.display = 'block';
                        elements.promotionCategory.value = promo.appliesToValue;
                    }
                    elements.promotionStartDate.value = promo.startDate;
                    elements.promotionEndDate.value = promo.endDate || '';
                }
            }
            showModal(elements.promotionModal);
        }

        async function savePromotion(event) {
            event.preventDefault();

            const promotionId = elements.promotionId.value || crypto.randomUUID();
            const code = elements.promotionCode.value.trim();
            const value = parseFloat(elements.promotionValue.value);
            const type = elements.promotionType.value;
            const appliesTo = elements.promotionAppliesTo.value;
            let appliesToValue = null;
            let appliesToValueTitle = null;

            if (value <= 0) {
                showToast('Discount value must be greater than zero.', 'error');
                return;
            }
            if (type === 'percentage' && value > 100) {
                showToast('Percentage discount cannot exceed 100%.', 'error');
                return;
            }

            if (appliesTo === 'specific-book') {
                appliesToValue = elements.promotionBookId.value;
                appliesToValueTitle = elements.promotionBookId.options[elements.promotionBookId.selectedIndex].text;
                if (!appliesToValue) {
                    showToast('Please select a book for this promotion.', 'error');
                    return;
                }
            } else if (appliesTo === 'specific-category') {
                appliesToValue = elements.promotionCategory.value.trim();
                appliesToValueTitle = appliesToValue;
                if (!appliesToValue) {
                    showToast('Please enter a category for this promotion.', 'error');
                    return;
                }
            }

            const existingPromotions = await getAllData(OBJECT_STORES.PROMOTIONS);
            const duplicateCode = existingPromotions.find(p => p.code.toLowerCase() === code.toLowerCase() && p.id !== promotionId);
            if (duplicateCode) {
                showToast('A promotion with this code already exists.', 'error');
                return;
            }

            const promotion = {
                id: promotionId,
                code: code,
                type: type,
                value: value,
                appliesTo: appliesTo,
                appliesToValue: appliesToValue,
                appliesToValueTitle: appliesToValueTitle,
                startDate: elements.promotionStartDate.value,
                endDate: elements.promotionEndDate.value || null
            };

            try {
                if (elements.promotionId.value) {
                    await updateData(OBJECT_STORES.PROMOTIONS, promotion);
                    showToast('Promotion updated successfully!', 'success');
                } else {
                    await addData(OBJECT_STORES.PROMOTIONS, promotion);
                    showToast('Promotion added successfully!', 'success');
                }
                hideModal(elements.promotionModal);
                await renderPromotions();
            } catch (error) {
                console.error('Failed to save promotion:', error);
                showToast(`Failed to save promotion: ${error.message || error}`, 'error');
            }
        }

        async function deletePromotion(promotionId) {
            if (!confirm('Are you sure you want to delete this promotion?')) return;
            try {
                await deleteData(OBJECT_STORES.PROMOTIONS, promotionId);
                showToast('Promotion deleted successfully!', 'success');
                await renderPromotions();
            } catch (error) {
                console.error('Failed to delete promotion:', error);
                showToast('Failed to delete promotion.', 'error');
            }
        }


        async function renderExpenses() {
            let expenses = await getAllData(OBJECT_STORES.EXPENSES);
            const searchTerm = elements.expenseSearch.value.toLowerCase();
            const monthFilter = elements.expenseMonthFilter.value;

            if (searchTerm) {
                expenses = expenses.filter(expense =>
                    expense.description.toLowerCase().includes(searchTerm) ||
                    expense.category.toLowerCase().includes(searchTerm)
                );
            }

            let monthlyTotal = 0;
            if (monthFilter) {
                expenses = expenses.filter(expense => {
                    const expenseMonth = new Date(expense.date).toISOString().slice(0, 7); // YYYY-MM
                    return expenseMonth === monthFilter;
                });
            }

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            monthlyTotal = expenses.reduce((sum, exp) => sum + exp.amount, 0);

            updatePaginationControls(pagination.expenses, expenses.length);
            const startIndex = (pagination.expenses.currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const paginatedExpenses = expenses.slice(startIndex, endIndex);

            elements.expensesList.innerHTML = paginatedExpenses.length > 0 ? paginatedExpenses.map(expense => `
                <tr>
                    <td>${formatShortDate(new Date(expense.date))}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td>${formatCurrency(expense.amount)}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="openExpenseModal('${expense.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="5">No expenses recorded for this period.</td></tr>`;

            elements.monthlyExpensesTotal.textContent = formatCurrency(monthlyTotal);
        }

        async function openExpenseModal(expenseId = null) {
            elements.expenseForm.reset();
            elements.expenseId.value = '';
            elements.expenseModalTitle.textContent = 'Add New Expense';
            elements.expenseDate.value = new Date().toISOString().split('T')[0];

            if (expenseId) {
                const expense = await getData(OBJECT_STORES.EXPENSES, expenseId);
                if (expense) {
                    elements.expenseModalTitle.textContent = 'Edit Expense';
                    elements.expenseId.value = expense.id;
                    elements.expenseDate.value = expense.date;
                    elements.expenseCategory.value = expense.category;
                    elements.expenseDescription.value = expense.description;
                    elements.expenseAmount.value = expense.amount;
                }
            }
            showModal(elements.expenseModal);
        }

        async function saveExpense(event) {
            event.preventDefault();

            const amount = parseFloat(elements.expenseAmount.value);
            if (amount < 0) {
                showToast('Expense amount cannot be negative.', 'error');
                return;
            }

            const expenseId = elements.expenseId.value || crypto.randomUUID();
            const expense = {
                id: expenseId,
                date: elements.expenseDate.value,
                category: elements.expenseCategory.value,
                description: elements.expenseDescription.value,
                amount: amount
            };

            try {
                if (elements.expenseId.value) {
                    await updateData(OBJECT_STORES.EXPENSES, expense);
                    showToast('Expense updated successfully!', 'success');
                } else {
                    await addData(OBJECT_STORES.EXPENSES, expense);
                    showToast('Expense added successfully!', 'success');
                }
                hideModal(elements.expenseModal);
                await renderExpenses();
            } catch (error) {
                console.error('Failed to save expense:', error);
                showToast(`Failed to save expense: ${error.message || error}`, 'error');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            try {
                await deleteData(OBJECT_STORES.EXPENSES, expenseId);
                showToast('Expense deleted successfully!', 'success');
                await renderExpenses();
            } catch (error) {
                console.error('Failed to delete expense:', error);
                showToast('Failed to delete expense.', 'error');
            }
        }


        async function renderSalesHistory() {
            let sales = await getAllData(OBJECT_STORES.SALES);
            const searchTerm = elements.saleSearch.value.toLowerCase();

            if (searchTerm) {
                sales = sales.filter(sale =>
                    (sale.customerName && sale.customerName.toLowerCase().includes(searchTerm)) ||
                    sale.id.toLowerCase().includes(searchTerm) ||
                    sale.items.some(item => item.title.toLowerCase().includes(searchTerm))
                );
            }

            sales.sort((a, b) => b.timestamp - a.timestamp);

            updatePaginationControls(pagination.sales, sales.length);
            const startIndex = (pagination.sales.currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const paginatedSales = sales.slice(startIndex, endIndex);

            elements.salesList.innerHTML = paginatedSales.length > 0 ? paginatedSales.map(sale => `
                <tr>
                    <td>${sale.id.substring(0, 8)}...</td>
                    <td>${formatDate(sale.timestamp)}</td>
                    <td>${sale.customerName || 'Guest'}</td>
                    <td>${sale.items.length} items (${sale.items.map(item => item.title).join(', ')})</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td class="actions">
                        <button class="btn btn-info btn-sm" onclick="viewSaleDetails('${sale.id}')"><i class="fas fa-eye"></i> View</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="6">No sales recorded.</td></tr>`;
        }

        async function viewSaleDetails(saleId) {
            const sale = await getData(OBJECT_STORES.SALES, saleId);
            if (sale) {
                elements.saleDetailsId.textContent = sale.id;
                elements.saleDetailsDate.textContent = formatDate(sale.timestamp);
                elements.saleDetailsCustomer.textContent = sale.customerName || 'Guest';
                elements.saleDetailsSubtotal.textContent = formatCurrency(sale.subtotal);
                elements.saleDetailsTotal.textContent = formatCurrency(sale.total);

                if (sale.discount > 0) {
                    elements.saleDetailsDiscountLine.style.display = 'block';
                    elements.saleDetailsDiscountValue.textContent = formatCurrency(sale.discount);
                } else {
                    elements.saleDetailsDiscountLine.style.display = 'none';
                }


                elements.saleDetailsItems.innerHTML = sale.items.map(item => `
                    <tr>
                        <td>${item.title}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${item.discount > 0 ? formatCurrency(item.discount) : 'N/A'}</td>
                        <td>${formatCurrency((item.price * item.quantity) - item.discount)}</td>
                    </tr>
                `).join('');
                elements.reprintReceiptBtn.onclick = () => {
                    hideModal(elements.viewSaleModal);
                    openReceiptModal(sale);
                };
                showModal(elements.viewSaleModal);
            } else {
                showToast('Sale record not found.', 'error');
            }
        }

        function openReceiptModal(sale) {
            elements.receiptSaleId.textContent = sale.id;
            elements.receiptDate.textContent = formatDate(sale.timestamp);
            elements.receiptCustomer.textContent = sale.customerName || 'Guest';
            elements.receiptSubtotal.textContent = formatCurrency(sale.subtotal);
            elements.receiptGrandTotal.textContent = formatCurrency(sale.total);

            if (sale.discount > 0) {
                elements.receiptDiscountLine.style.display = 'block';
                elements.receiptDiscountValue.textContent = formatCurrency(sale.discount);
            } else {
                elements.receiptDiscountLine.style.display = 'none';
            }

            elements.receiptItemsList.innerHTML = sale.items.map(item => `
                <tr>
                    <td style="text-align: left; padding: 2px 0;">${item.title}</td>
                    <td style="text-align: right; padding: 2px 0;">${item.quantity}</td>
                    <td style="text-align: right; padding: 2px 0;">${formatCurrency(item.price)}</td>
                    <td style="text-align: right; padding: 2px 0;">${formatCurrency((item.price * item.quantity) - item.discount)}</td>
                </tr>
            `).join('');

            showModal(elements.receiptModal);
        }

        async function printReceipt() {
            const receiptContent = document.getElementById('receipt-content').cloneNode(true);
            receiptContent.style.padding = '20px';
            receiptContent.style.backgroundColor = 'white';
            receiptContent.style.color = 'black';
            receiptContent.style.position = 'absolute'; // Position off-screen for accurate rendering
            receiptContent.style.left = '-9999px';
            document.body.appendChild(receiptContent);


            html2canvas(receiptContent, {
                scale: 2
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const {
                    jsPDF
                } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.autoPrint();
                window.open(pdf.output('bloburl'), '_blank');
            }).catch(error => {
                console.error('Error generating PDF for print:', error);
                showToast('Failed to generate printable receipt.', 'error');
            }).finally(() => {
                receiptContent.remove();
            });
        }

        async function downloadReceiptPdf() {
            const receiptContent = document.getElementById('receipt-content').cloneNode(true);
            receiptContent.style.padding = '20px';
            receiptContent.style.backgroundColor = 'white';
            receiptContent.style.color = 'black';
            receiptContent.style.position = 'absolute'; // Position off-screen for accurate rendering
            receiptContent.style.left = '-9999px';
            document.body.appendChild(receiptContent);

            html2canvas(receiptContent, {
                scale: 2
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const {
                    jsPDF
                } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                const saleId = elements.receiptSaleId.textContent;
                pdf.save(`Receipt_Sale_${saleId.substring(0, 8)}.pdf`);
            }).catch(error => {
                console.error('Error generating PDF for download:', error);
                showToast('Failed to download receipt PDF.', 'error');
            }).finally(() => {
                receiptContent.remove();
            });
        }

        function updateReportFilters() {
            const type = elements.reportType.value;
            elements.reportDateFilter.style.display = 'none';
            elements.reportMonthFilter.style.display = 'none';
            elements.reportYearFilter.style.display = 'none';

            const today = new Date();

            if (type === 'sales-daily') {
                elements.reportDateFilter.style.display = 'block';
                elements.reportDate.value = today.toISOString().slice(0, 10); // YYYY-MM-DD
            } else if (type === 'sales-weekly' || type === 'sales-monthly' || type === 'expenses-summary') {
                elements.reportMonthFilter.style.display = 'block';
                elements.reportMonth.value = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            } else if (type === 'best-selling' || type === 'best-selling-authors' || type === 'low-stock') {
                // No specific date filters needed, but could add yearly if desired
            }
        }

        async function generateReport() {
            const type = elements.reportType.value;
            let reportHtml = '';
            currentReportData = [];
            let chartData = null;

            elements.reportResultsHeader.textContent = `Report Results: ${elements.reportType.options[elements.reportType.selectedIndex].text}`;
            elements.exportCurrentReportBtn.disabled = true;

            if (reportChartInstance) {
                reportChartInstance.destroy();
                reportChartInstance = null;
            }

            switch (type) {
                case 'sales-daily':
                    ({
                        reportHtml,
                        chartData
                    } = await generateDailySalesReport());
                    break;
                case 'sales-weekly':
                    ({
                        reportHtml,
                        chartData
                    } = await generateWeeklySalesReport());
                    break;
                case 'sales-monthly':
                    ({
                        reportHtml,
                        chartData
                    } = await generateMonthlySalesReport());
                    break;
                case 'best-selling':
                    ({
                        reportHtml,
                        chartData
                    } = await generateBestSellingBooksReport());
                    break;
                case 'best-selling-authors':
                    ({
                        reportHtml,
                        chartData
                    } = await generateBestSellingAuthorsReport());
                    break;
                case 'low-stock':
                    reportHtml = await generateLowStockReport();
                    break;
                case 'expenses-summary':
                    ({
                        reportHtml,
                        chartData
                    } = await generateExpensesSummaryReport());
                    break;
                default:
                    reportHtml = `<tr><td colspan="3">No report selected or report type invalid.</td></tr>`;
                    break;
            }
            elements.reportResultsTable.querySelector('tbody').innerHTML = reportHtml;
            elements.exportCurrentReportBtn.disabled = currentReportData.length === 0;

            if (chartData) {
                renderChart(chartData.labels, chartData.datasets, chartData.type, chartData.title);
            }
        }

        function renderChart(labels, datasets, type, title) {
            const ctx = elements.reportChart.getContext('2d');
            reportChartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        },
                        title: {
                            display: true,
                            text: title,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--primary-color'),
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--light-text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        },
                        y: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--light-text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        }
                    }
                }
            });
        }


        async function generateDailySalesReport() {
            const selectedDate = elements.reportDate.value;
            if (!selectedDate) {
                showToast('Please select a date for the daily sales report.', 'error');
                return {
                    reportHtml: `<tr><td colspan="3">Please select a date.</td></tr>`,
                    chartData: null
                };
            }
            const startOfDay = new Date(selectedDate);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(selectedDate);
            endOfDay.setHours(23, 59, 59, 999);

            const sales = await getAllData(OBJECT_STORES.SALES);
            const dailySales = sales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return saleDate >= startOfDay && saleDate <= endOfDay;
            });

            const totalSales = dailySales.reduce((sum, sale) => sum + sale.total, 0);
            const totalItemsSold = dailySales.reduce((sum, sale) => sum + sale.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
            const totalDiscountApplied = dailySales.reduce((sum, sale) => sum + sale.discount, 0);

            currentReportData = [{
                Metric: `Date`,
                Value: selectedDate
            }, {
                Metric: `Total Sales`,
                Value: formatCurrency(totalSales)
            }, {
                Metric: `Number of Sales`,
                Value: dailySales.length
            }, {
                Metric: `Total Items Sold`,
                Value: totalItemsSold
            }, {
                Metric: `Total Discount Applied`,
                Value: formatCurrency(totalDiscountApplied)
            }];

            const chartData = {
                labels: ['Total Sales', 'Total Discount'],
                datasets: [{
                    label: 'Amount (PKR)',
                    data: [totalSales, totalDiscountApplied],
                    backgroundColor: ['#2a9d8f', '#f4a261'],
                    borderColor: ['#2a9d8f', '#f4a261'],
                    borderWidth: 1
                }],
                type: 'bar',
                title: `Daily Sales Report for ${selectedDate}`
            };

            return {
                reportHtml: `
                <tr><td>Date</td><td>${selectedDate}</td><td></td></tr>
                <tr><td>Total Sales</td><td>${formatCurrency(totalSales)}</td><td></td></tr>
                <tr><td>Number of Sales</td><td>${dailySales.length}</td><td></td></tr>
                <tr><td>Total Items Sold</td><td>${totalItemsSold}</td><td></td></tr>
                <tr><td>Total Discount Applied</td><td>${formatCurrency(totalDiscountApplied)}</td><td></td></tr>
            `,
                chartData: chartData
            };
        }

        async function generateWeeklySalesReport() {
            const selectedMonthStr = elements.reportMonth.value;
            if (!selectedMonthStr) {
                showToast('Please select a month for the weekly sales report.', 'error');
                return {
                    reportHtml: `<tr><td colspan="3">Please select a month.</td></tr>`,
                    chartData: null
                };
            }

            const [year, month] = selectedMonthStr.split('-').map(Number);
            const sales = await getAllData(OBJECT_STORES.SALES);

            const salesByWeek = {};
            const weekStarts = [];

            // Calculate weeks within the selected month (Sunday to Saturday)
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const lastDayOfMonth = new Date(year, month, 0);

            let currentWeekStart = new Date(firstDayOfMonth);
            currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay()); // Go to previous Sunday

            while (currentWeekStart <= lastDayOfMonth || currentWeekStart.getMonth() === month - 1) {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                const weekKey = `${formatShortDate(currentWeekStart)} - ${formatShortDate(weekEnd)}`;
                weekStarts.push({
                    start: new Date(currentWeekStart),
                    end: new Date(weekEnd),
                    key: weekKey
                });
                salesByWeek[weekKey] = {
                    total: 0,
                    count: 0,
                    items: 0
                };

                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            }

            sales.forEach(sale => {
                const saleDate = new Date(sale.timestamp);
                const relevantWeek = weekStarts.find(week =>
                    saleDate >= week.start && saleDate <= week.end
                );
                if (relevantWeek) {
                    if (salesByWeek[relevantWeek.key]) {
                        salesByWeek[relevantWeek.key].total += sale.total;
                        salesByWeek[relevantWeek.key].count++;
                        salesByWeek[relevantWeek.key].items += sale.items.reduce((sum, item) => sum + item.quantity, 0);
                    }
                }
            });

            let html = ``;
            currentReportData = [];
            currentReportData.push({
                Metric: 'Month',
                Value: selectedMonthStr
            });

            const chartLabels = [];
            const chartDataSales = [];

            weekStarts.forEach(week => {
                const data = salesByWeek[week.key];
                html += `
                    <tr><td>${week.key}</td><td>${formatCurrency(data.total)}</td><td>${data.count} sales, ${data.items} items</td></tr>
                `;
                currentReportData.push({
                    Metric: week.key,
                    Value: `${formatCurrency(data.total)} (${data.count} sales, ${data.items} items)`
                });
                chartLabels.push(week.key);
                chartDataSales.push(data.total);
            });


            const chartData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Weekly Sales (PKR)',
                    data: chartDataSales,
                    backgroundColor: 'rgba(42, 157, 143, 0.7)',
                    borderColor: 'rgba(42, 157, 143, 1)',
                    borderWidth: 1,
                    fill: false,
                    tension: 0.3
                }],
                type: 'line',
                title: `Weekly Sales Report for ${selectedMonthStr}`
            };


            return {
                reportHtml: html || `<tr><td colspan="3">No weekly sales found for ${selectedMonthStr}.</td></tr>`,
                chartData: chartData
            };
        }

        async function generateMonthlySalesReport() {
            const selectedMonthStr = elements.reportMonth.value;
            if (!selectedMonthStr) {
                showToast('Please select a month for the monthly sales report.', 'error');
                return {
                    reportHtml: `<tr><td colspan="3">Please select a month.</td></tr>`,
                    chartData: null
                };
            }

            const [year, month] = selectedMonthStr.split('-').map(Number);
            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 0);
            endOfMonth.setHours(23, 59, 59, 999);

            const sales = await getAllData(OBJECT_STORES.SALES);
            const monthlySales = sales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return saleDate >= startOfMonth && saleDate <= endOfMonth;
            });

            const totalSales = monthlySales.reduce((sum, sale) => sum + sale.total, 0);
            const totalItemsSold = monthlySales.reduce((sum, sale) => sum + sale.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
            const totalDiscountApplied = monthlySales.reduce((sum, sale) => sum + sale.discount, 0);


            currentReportData = [{
                Metric: `Month`,
                Value: selectedMonthStr
            }, {
                Metric: `Total Sales`,
                Value: formatCurrency(totalSales)
            }, {
                Metric: `Number of Sales`,
                Value: monthlySales.length
            }, {
                Metric: `Total Items Sold`,
                Value: totalItemsSold
            }, {
                Metric: `Total Discount Applied`,
                Value: formatCurrency(totalDiscountApplied)
            }];

            const chartData = {
                labels: ['Total Sales', 'Total Discount'],
                datasets: [{
                    label: 'Amount (PKR)',
                    data: [totalSales, totalDiscountApplied],
                    backgroundColor: ['#2a9d8f', '#f4a261'],
                    borderColor: ['#2a9d8f', '#f4a261'],
                    borderWidth: 1
                }],
                type: 'bar',
                title: `Monthly Sales Report for ${selectedMonthStr}`
            };

            return {
                reportHtml: `
                <tr><td>Month</td><td>${selectedMonthStr}</td><td></td></tr>
                <tr><td>Total Sales</td><td>${formatCurrency(totalSales)}</td><td></td></tr>
                <tr><td>Number of Sales</td><td>${monthlySales.length}</td><td></td></tr>
                <tr><td>Total Items Sold</td><td>${totalItemsSold}</td><td></td></tr>
                <tr><td>Total Discount Applied</td><td>${formatCurrency(totalDiscountApplied)}</td><td></td></tr>
            `,
                chartData: chartData
            };
        }


        async function generateBestSellingBooksReport() {
            const sales = await getAllData(OBJECT_STORES.SALES);
            const bookSalesMap = new Map();

            sales.forEach(sale => {
                sale.items.forEach(item => {
                    const currentSales = bookSalesMap.get(item.bookId) || {
                        title: item.title,
                        quantitySold: 0,
                        totalRevenue: 0
                    };
                    currentSales.quantitySold += item.quantity;
                    currentSales.totalRevenue += (item.price * item.quantity) - item.discount;
                    bookSalesMap.set(item.bookId, currentSales);
                });
            });

            const bestSellingBooks = Array.from(bookSalesMap.values())
                .sort((a, b) => b.quantitySold - a.quantitySold)
                .slice(0, 10);

            currentReportData = bestSellingBooks.map((book, index) => ({
                Rank: index + 1,
                Title: book.title,
                'Units Sold': book.quantitySold,
                Revenue: formatCurrency(book.totalRevenue)
            }));

            const chartLabels = bestSellingBooks.map(book => book.title);
            const chartDataSales = bestSellingBooks.map(book => book.quantitySold);
            const chartDataRevenue = bestSellingBooks.map(book => book.totalRevenue);

            const chartData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Units Sold',
                    data: chartDataSales,
                    backgroundColor: 'rgba(42, 157, 143, 0.7)',
                    borderColor: 'rgba(42, 157, 143, 1)',
                    borderWidth: 1
                }, {
                    label: 'Revenue (PKR)',
                    data: chartDataRevenue,
                    backgroundColor: 'rgba(244, 162, 97, 0.7)',
                    borderColor: 'rgba(244, 162, 97, 1)',
                    borderWidth: 1
                }],
                type: 'bar',
                title: 'Top 10 Best-Selling Books'
            };

            return {
                reportHtml: bestSellingBooks.length > 0 ? bestSellingBooks.map((book, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${book.title}</td>
                    <td>${book.quantitySold} units sold, ${formatCurrency(book.totalRevenue)} revenue</td>
                </tr>
            `).join('') : `<tr><td colspan="3">No sales data to generate best-selling report.</td></tr>`,
                chartData: chartData
            };
        }

        async function generateBestSellingAuthorsReport() {
            const sales = await getAllData(OBJECT_STORES.SALES);
            const bookAuthorMap = {};
            const authorSalesMap = new Map();

            // First get all books to map bookId to author
            const allBooks = await getAllData(OBJECT_STORES.BOOKS);
            allBooks.forEach(book => {
                bookAuthorMap[book.id] = book.author;
            });

            sales.forEach(sale => {
                sale.items.forEach(item => {
                    const author = bookAuthorMap[item.bookId] || 'Unknown Author';
                    const currentSales = authorSalesMap.get(author) || {
                        author: author,
                        quantitySold: 0,
                        totalRevenue: 0
                    };
                    currentSales.quantitySold += item.quantity;
                    currentSales.totalRevenue += (item.price * item.quantity) - item.discount;
                    authorSalesMap.set(author, currentSales);
                });
            });

            const bestSellingAuthors = Array.from(authorSalesMap.values())
                .sort((a, b) => b.quantitySold - a.quantitySold)
                .slice(0, 10);

            currentReportData = bestSellingAuthors.map((author, index) => ({
                Rank: index + 1,
                Author: author.author,
                'Units Sold': author.quantitySold,
                Revenue: formatCurrency(author.totalRevenue)
            }));

            const chartLabels = bestSellingAuthors.map(author => author.author);
            const chartDataSales = bestSellingAuthors.map(author => author.quantitySold);
            const chartDataRevenue = bestSellingAuthors.map(author => author.totalRevenue);

            const chartData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Units Sold',
                    data: chartDataSales,
                    backgroundColor: 'rgba(42, 157, 143, 0.7)',
                    borderColor: 'rgba(42, 157, 143, 1)',
                    borderWidth: 1
                }, {
                    label: 'Revenue (PKR)',
                    data: chartDataRevenue,
                    backgroundColor: 'rgba(244, 162, 97, 0.7)',
                    borderColor: 'rgba(244, 162, 97, 1)',
                    borderWidth: 1
                }],
                type: 'bar',
                title: 'Top 10 Best-Selling Authors'
            };

            return {
                reportHtml: bestSellingAuthors.length > 0 ? bestSellingAuthors.map((author, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${author.author}</td>
                    <td>${author.quantitySold} units sold, ${formatCurrency(author.totalRevenue)} revenue</td>
                </tr>
            `).join('') : `<tr><td colspan="3">No sales data to generate best-selling author report.</td></tr>`,
                chartData: chartData
            };
        }


        async function generateLowStockReport() {
            const books = await getAllData(OBJECT_STORES.BOOKS);
            const lowStockBooks = books.filter(book => book.stock < 5)
                .sort((a, b) => a.stock - b.stock);

            currentReportData = lowStockBooks.map((book, index) => ({
                Rank: index + 1,
                Title: book.title,
                Author: book.author,
                Stock: book.stock,
                ISBN: book.isbn
            }));

            const chartLabels = lowStockBooks.map(book => book.title);
            const chartDataStock = lowStockBooks.map(book => book.stock);

            const chartData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Stock Quantity',
                    data: chartDataStock,
                    backgroundColor: 'rgba(231, 111, 81, 0.7)',
                    borderColor: 'rgba(231, 111, 81, 1)',
                    borderWidth: 1
                }],
                type: 'bar',
                title: 'Books Low in Stock (< 5 units)'
            };


            return {
                reportHtml: lowStockBooks.length > 0 ? lowStockBooks.map((book, index) => `
                <tr class="low-stock">
                    <td>${index + 1}</td>
                    <td>${book.title} (${book.author})</td>
                    <td>${book.stock} in stock</td>
                </tr>
            `).join('') : `<tr><td colspan="3">No books currently low in stock.</td></tr>`,
                chartData: chartData
            };
        }

        async function generateExpensesSummaryReport() {
            const selectedMonthStr = elements.expenseMonthFilter.value;
            if (!selectedMonthStr) {
                showToast('Please select a month for the expenses summary report.', 'error');
                return {
                    reportHtml: `<tr><td colspan="3">Please select a month.</td></tr>`,
                    chartData: null
                };
            }

            const [year, month] = selectedMonthStr.split('-').map(Number);
            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 0);
            endOfMonth.setHours(23, 59, 59, 999);

            const expenses = await getAllData(OBJECT_STORES.EXPENSES);
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= startOfMonth && expenseDate <= endOfMonth;
            });

            const expensesByCategory = {};
            let totalExpenses = 0;

            monthlyExpenses.forEach(expense => {
                expensesByCategory[expense.category] = (expensesByCategory[expense.category] || 0) + expense.amount;
                totalExpenses += expense.amount;
            });

            let html = ``;
            currentReportData = [{
                Metric: 'Month',
                Value: selectedMonthStr
            }, {
                Metric: 'Total Monthly Expenses',
                Value: formatCurrency(totalExpenses)
            }];

            const chartLabels = Object.keys(expensesByCategory);
            const chartDataAmounts = Object.values(expensesByCategory);
            const backgroundColors = chartLabels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`); // Generate distinct colors

            chartLabels.forEach(category => {
                html += `<tr><td>-</td><td>${category}</td><td>${formatCurrency(expensesByCategory[category])}</td></tr>`;
                currentReportData.push({
                    Metric: category,
                    Value: formatCurrency(expensesByCategory[category])
                });
            });
            html += `<tr><td><strong>Total</strong></td><td></td><td><strong>${formatCurrency(totalExpenses)}</strong></td></tr>`;


            const chartData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Amount (PKR)',
                    data: chartDataAmounts,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }],
                type: 'pie', // Pie chart for categories
                title: `Expenses Summary for ${selectedMonthStr}`
            };

            return {
                reportHtml: html || `<tr><td colspan="3">No expenses recorded for ${selectedMonthStr}.</td></tr>`,
                chartData: chartData
            };
        }

        function exportCurrentReport() {
            if (currentReportData.length === 0) {
                showToast('No report data to export.', 'warning');
                return;
            }

            const reportType = elements.reportType.options[elements.reportType.selectedIndex].text;
            const filename = `${reportType.replace(/\s/g, '_')}_Report_${new Date().toISOString().slice(0, 10)}.json`;

            const jsonString = JSON.stringify(currentReportData, null, 2);
            const blob = new Blob([jsonString], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Report data exported successfully!', 'success');
        }

        function downloadDataAsCsv(data, filename) {
            if (!data || data.length === 0) {
                showToast('No data to export.', 'warning');
                return;
            }

            const header = Object.keys(data[0]);
            const csv = [
                header.join(','),
                ...data.map(row => header.map(fieldName => {
                    let value = row[fieldName];
                    if (typeof value === 'string') {
                        value = value.replace(/"/g, '""'); // Escape double quotes
                    } else if (typeof value === 'object' && value !== null) {
                        value = JSON.stringify(value).replace(/"/g, '""'); // Stringify objects and escape quotes
                    }
                    return `"${value}"`; // Enclose all values in double quotes
                }).join(','))
            ].join('\n');

            const blob = new Blob([csv], {
                type: 'text/csv;charset=utf-8;'
            });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Data exported successfully!', 'success');
            } else {
                showToast('Your browser does not support downloading files.', 'error');
            }
        }

        async function exportBooks() {
            const books = await getAllData(OBJECT_STORES.BOOKS);
            downloadDataAsCsv(books, 'books_export.csv');
        }

        async function exportCustomers() {
            const customers = await getAllData(OBJECT_STORES.CUSTOMERS);
            downloadDataAsCsv(customers, 'customers_export.csv');
        }

        async function exportSuppliers() {
            const suppliers = await getAllData(OBJECT_STORES.SUPPLIERS);
            downloadDataAsCsv(suppliers, 'suppliers_export.csv');
        }

        async function exportPurchaseOrders() {
            const purchaseOrders = await getAllData(OBJECT_STORES.PURCHASE_ORDERS);
            downloadDataAsCsv(purchaseOrders.map(po => ({
                id: po.id,
                supplierId: po.supplierId,
                supplierName: po.supplierName,
                orderDate: po.orderDate,
                expectedDate: po.expectedDate,
                status: po.status,
                items: JSON.stringify(po.items),
                totalCost: po.totalCost
            })), 'purchase_orders_export.csv');
        }

        async function exportSales() {
            const sales = await getAllData(OBJECT_STORES.SALES);
            downloadDataAsCsv(sales.map(s => ({
                id: s.id,
                timestamp: new Date(s.timestamp).toISOString(),
                customerId: s.customerId,
                customerName: s.customerName,
                items: JSON.stringify(s.items), // Stringify items array to fit in one CSV cell
                subtotal: s.subtotal,
                discount: s.discount,
                total: s.total,
                promotionCode: s.promotionCode
            })), 'sales_export.csv');
        }

        async function importBooks(file, conflictResolution) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    showToast('No file selected.', 'error');
                    return reject('No file selected');
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error('Invalid JSON format: expected an array.');

                        const transaction = db.transaction([OBJECT_STORES.BOOKS], 'readwrite');
                        const store = transaction.objectStore(OBJECT_STORES.BOOKS);
                        const isbnIndex = store.index('isbn');

                        let newCount = 0;
                        let updatedCount = 0;
                        let skippedCount = 0;

                        for (const book of data) {
                            if (!book.id) book.id = crypto.randomUUID();
                            if (!book.isbn) {
                                showToast(`Skipped a book due to missing ISBN.`, 'warning');
                                skippedCount++;
                                continue;
                            }

                            const existingBookRequest = isbnIndex.get(book.isbn);
                            await new Promise((res) => {
                                existingBookRequest.onsuccess = async () => {
                                    const existingBook = existingBookRequest.result;
                                    if (existingBook) {
                                        if (conflictResolution === 'update') {
                                            const updatedBook = {
                                                ...existingBook,
                                                ...book,
                                                id: existingBook.id
                                            }; // Preserve old ID
                                            await new Promise((resolveUpdate) => {
                                                const putRequest = store.put(updatedBook);
                                                putRequest.onsuccess = () => resolveUpdate();
                                                putRequest.onerror = (err) => {
                                                    console.error(`Error updating book ${book.title}:`, err);
                                                    showToast(`Error updating book "${book.title}": ${err.message}`, 'error');
                                                    resolveUpdate();
                                                };
                                            });
                                            updatedCount++;
                                        } else { // skip
                                            skippedCount++;
                                        }
                                    } else {
                                        await new Promise((resolveAdd) => {
                                            const addRequest = store.add(book);
                                            addRequest.onsuccess = () => resolveAdd();
                                            addRequest.onerror = (err) => {
                                                console.error(`Error adding book ${book.title}:`, err);
                                                showToast(`Error adding book "${book.title}": ${err.message}`, 'error');
                                                resolveAdd();
                                            };
                                        });
                                        newCount++;
                                    }
                                    res();
                                };
                                existingBookRequest.onerror = (err) => {
                                    console.error(`Error checking ISBN for book ${book.title}:`, err);
                                    showToast(`Error checking ISBN for book "${book.title}": ${err.message}`, 'error');
                                    res();
                                };
                            });
                        }

                        await new Promise((res) => {
                            transaction.oncomplete = () => res();
                            transaction.onerror = (err) => reject(err);
                        });

                        showToast(`Books import complete: ${newCount} new, ${updatedCount} updated, ${skippedCount} skipped.`, 'success');
                        await renderBooks();
                        await updateDashboard();
                        resolve();
                    } catch (error) {
                        console.error('Error importing books:', error);
                        showToast(`Error importing books: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = (error) => {
                    showToast('Failed to read file.', 'error');
                    reject(error);
                };
                reader.readAsText(file);
            });
        }

        async function importCustomers(file, conflictResolution) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    showToast('No file selected.', 'error');
                    return reject('No file selected');
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error('Invalid JSON format: expected an array.');

                        const transaction = db.transaction([OBJECT_STORES.CUSTOMERS], 'readwrite');
                        const store = transaction.objectStore(OBJECT_STORES.CUSTOMERS);
                        const emailIndex = store.index('email');

                        let newCount = 0;
                        let updatedCount = 0;
                        let skippedCount = 0;

                        for (const customer of data) {
                            if (!customer.id) customer.id = crypto.randomUUID();
                            if (!customer.email) {
                                showToast(`Skipped customer "${customer.name || 'Unknown'}" due to missing email.`, 'warning');
                                skippedCount++;
                                continue;
                            }

                            const existingCustomerRequest = emailIndex.get(customer.email);
                            await new Promise((res) => {
                                existingCustomerRequest.onsuccess = async () => {
                                    const existingCustomer = existingCustomerRequest.result;
                                    if (existingCustomer) {
                                        if (conflictResolution === 'update') {
                                            const updatedCustomer = {
                                                ...existingCustomer,
                                                ...customer,
                                                id: existingCustomer.id
                                            }; // Preserve old ID and isActive
                                            await new Promise((resolveUpdate) => {
                                                const putRequest = store.put(updatedCustomer);
                                                putRequest.onsuccess = () => resolveUpdate();
                                                putRequest.onerror = (err) => {
                                                    console.error(`Error updating customer ${customer.name}:`, err);
                                                    showToast(`Error updating customer "${customer.name}": ${err.message}`, 'error');
                                                    resolveUpdate();
                                                };
                                            });
                                            updatedCount++;
                                        } else { // skip
                                            skippedCount++;
                                        }
                                    } else {
                                        if (typeof customer.isActive === 'undefined') customer.isActive = true;
                                        await new Promise((resolveAdd) => {
                                            const addRequest = store.add(customer);
                                            addRequest.onsuccess = () => resolveAdd();
                                            addRequest.onerror = (err) => {
                                                console.error(`Error adding customer ${customer.name}:`, err);
                                                showToast(`Error adding customer "${customer.name}": ${err.message}`, 'error');
                                                resolveAdd();
                                            };
                                        });
                                        newCount++;
                                    }
                                    res();
                                };
                                existingCustomerRequest.onerror = (err) => {
                                    console.error(`Error checking email for customer ${customer.name}:`, err);
                                    showToast(`Error checking email for customer "${customer.name}": ${err.message}`, 'error');
                                    res();
                                };
                            });
                        }

                        await new Promise((res) => {
                            transaction.oncomplete = () => res();
                            transaction.onerror = (err) => reject(err);
                        });

                        showToast(`Customers import complete: ${newCount} new, ${updatedCount} updated, ${skippedCount} skipped.`, 'success');
                        await renderCustomers();
                        await updateDashboard();
                        resolve();
                    } catch (error) {
                        console.error('Error importing customers:', error);
                        showToast(`Error importing customers: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = (error) => {
                    showToast('Failed to read file.', 'error');
                    reject(error);
                };
                reader.readAsText(file);
            });
        }


        async function importSuppliers(file, conflictResolution) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    showToast('No file selected.', 'error');
                    return reject('No file selected');
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error('Invalid JSON format: expected an array.');

                        const transaction = db.transaction([OBJECT_STORES.SUPPLIERS], 'readwrite');
                        const store = transaction.objectStore(OBJECT_STORES.SUPPLIERS);
                        const emailIndex = store.index('email');

                        let newCount = 0;
                        let updatedCount = 0;
                        let skippedCount = 0;

                        for (const supplier of data) {
                            if (!supplier.id) supplier.id = crypto.randomUUID();
                            if (!supplier.email) {
                                showToast(`Skipped supplier "${supplier.name || 'Unknown'}" due to missing email.`, 'warning');
                                skippedCount++;
                                continue;
                            }

                            const existingSupplierRequest = emailIndex.get(supplier.email);
                            await new Promise((res) => {
                                existingSupplierRequest.onsuccess = async () => {
                                    const existingSupplier = existingSupplierRequest.result;
                                    if (existingSupplier) {
                                        if (conflictResolution === 'update') {
                                            const updatedSupplier = {
                                                ...existingSupplier,
                                                ...supplier,
                                                id: existingSupplier.id
                                            }; // Preserve old ID
                                            await new Promise((resolveUpdate) => {
                                                const putRequest = store.put(updatedSupplier);
                                                putRequest.onsuccess = () => resolveUpdate();
                                                putRequest.onerror = (err) => {
                                                    console.error(`Error updating supplier ${supplier.name}:`, err);
                                                    showToast(`Error updating supplier "${supplier.name}": ${err.message}`, 'error');
                                                    resolveUpdate();
                                                };
                                            });
                                            updatedCount++;
                                        } else { // skip
                                            skippedCount++;
                                        }
                                    } else {
                                        await new Promise((resolveAdd) => {
                                            const addRequest = store.add(supplier);
                                            addRequest.onsuccess = () => resolveAdd();
                                            addRequest.onerror = (err) => {
                                                console.error(`Error adding supplier ${supplier.name}:`, err);
                                                showToast(`Error adding supplier "${supplier.name}": ${err.message}`, 'error');
                                                resolveAdd();
                                            };
                                        });
                                        newCount++;
                                    }
                                    res();
                                };
                                existingSupplierRequest.onerror = (err) => {
                                    console.error(`Error checking email for supplier ${supplier.name}:`, err);
                                    showToast(`Error checking email for supplier "${supplier.name}": ${err.message}`, 'error');
                                    res();
                                };
                            });
                        }

                        await new Promise((res) => {
                            transaction.oncomplete = () => res();
                            transaction.onerror = (err) => reject(err);
                        });

                        showToast(`Suppliers import complete: ${newCount} new, ${updatedCount} updated, ${skippedCount} skipped.`, 'success');
                        await renderSuppliers();
                        resolve();
                    } catch (error) {
                        console.error('Error importing suppliers:', error);
                        showToast(`Error importing suppliers: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = (error) => {
                    showToast('Failed to read file.', 'error');
                    reject(error);
                };
                reader.readAsText(file);
            });
        }

        async function exportAllData() {
            const allData = {};
            for (const storeName of Object.values(OBJECT_STORES)) {
                allData[storeName] = await getAllData(storeName);
            }

            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookshop_data_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('All data exported successfully!', 'success');
        }

        async function importAllDataHandler() {
            const file = elements.importFile.files[0];
            if (!file) {
                showToast('Please select a JSON file to import.', 'error');
                return;
            }

            if (!confirm('WARNING: Importing data will CLEAR ALL existing data (books, customers, sales, etc.) and replace it with the imported data. Are you absolutely sure you want to proceed?')) {
                elements.importFile.value = '';
                elements.importAllDataBtn.disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    for (const storeName of Object.values(OBJECT_STORES)) {
                        if (!importedData[storeName] || !Array.isArray(importedData[storeName])) {
                            throw new Error(`Invalid backup file format: missing or invalid "${storeName}" data.`);
                        }
                    }

                    // Clear all stores
                    for (const storeName of Object.values(OBJECT_STORES)) {
                        await clearStore(storeName);
                    }

                    // Import data into each store in a specific order (e.g., books, customers, then sales, POs)
                    // This is important if sales/POs reference book/customer IDs.
                    for (const storeName of [OBJECT_STORES.BOOKS, OBJECT_STORES.CUSTOMERS, OBJECT_STORES.SUPPLIERS, OBJECT_STORES.PROMOTIONS, OBJECT_STORES.EXPENSES, OBJECT_STORES.PURCHASE_ORDERS, OBJECT_STORES.SALES]) {
                        for (const item of importedData[storeName]) {
                            await addData(storeName, item);
                        }
                    }

                    showToast('All data imported successfully!', 'success');
                    await renderAll(currentPage); // Re-render current page after full import
                    elements.importFile.value = '';
                    elements.importAllDataBtn.disabled = true;
                    // Force refresh after major data overwrite to ensure UI consistency
                    // window.location.reload(); 
                    // This is usually for PWA/Service worker updates, not needed here if IndexedDB updates correctly
                    // and renderAll() is robust enough. Keeping it commented for safety.
                } catch (error) {
                    console.error('Error importing all data:', error);
                    showToast(`Error importing data: ${error.message}`, 'error');
                } finally {
                    elements.importFile.value = '';
                    elements.importAllDataBtn.disabled = true;
                }
            };
            reader.readAsText(file);
        }

        function setupEventListeners() {
            elements.darkModeSwitch.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                }
            });

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                elements.darkModeSwitch.checked = true;
                document.documentElement.setAttribute('data-theme', 'dark');
            }

            elements.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(e.target.getAttribute('href').substring(1));
                });
            });

            elements.hamburgerMenu.addEventListener('click', () => {
                elements.sidebar.classList.toggle('active');
            });

            elements.modalCloseButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal-overlay');
                    if (modal) hideModal(modal);
                });
            });

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        hideModal(overlay);
                    }
                });
            });

            // Books
            elements.addBookBtn.addEventListener('click', () => openBookModal());
            elements.bookForm.addEventListener('submit', saveBook);
            elements.bookSearch.addEventListener('input', () => {
                pagination.books.currentPage = 1;
                renderBooks();
            });
            elements.bookSort.addEventListener('change', () => {
                pagination.books.currentPage = 1;
                renderBooks();
            });
            elements.booksPrevPage.addEventListener('click', () => {
                pagination.books.currentPage--;
                renderBooks();
            });
            elements.booksNextPage.addEventListener('click', () => {
                pagination.books.currentPage++;
                renderBooks();
            });

            elements.bookCoverImage.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        elements.bookCoverPreview.src = e.target.result;
                        elements.bookCoverPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    elements.bookCoverPreview.src = '';
                    elements.bookCoverPreview.style.display = 'none';
                }
            });
            elements.restockForm.addEventListener('submit', restockBook);
            elements.exportBooksBtn.addEventListener('click', exportBooks);
            elements.importBooksBtn.addEventListener('click', () => {
                showModal(elements.importBooksModal);
            });
            elements.importBooksForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = elements.importBooksFile.files[0];
                const conflictResolution = document.querySelector('input[name="import-conflict-books"]:checked').value;
                try {
                    await importBooks(file, conflictResolution);
                    hideModal(elements.importBooksModal);
                    elements.importBooksFile.value = '';
                } catch (error) {
                    // Handled by importBooks function
                }
            });

            // Customers
            elements.addCustomerBtn.addEventListener('click', () => openCustomerModal());
            elements.customerForm.addEventListener('submit', saveCustomer);
            elements.customerSearch.addEventListener('input', () => {
                pagination.customers.currentPage = 1;
                renderCustomers();
            });
            elements.customerFilterStatus.addEventListener('change', () => {
                pagination.customers.currentPage = 1;
                renderCustomers();
            });
            elements.customersPrevPage.addEventListener('click', () => {
                pagination.customers.currentPage--;
                renderCustomers();
            });
            elements.customersNextPage.addEventListener('click', () => {
                pagination.customers.currentPage++;
                renderCustomers();
            });
            elements.exportCustomersBtn.addEventListener('click', exportCustomers);
            elements.importCustomersBtn.addEventListener('click', () => {
                showModal(elements.importCustomersModal);
            });
            elements.importCustomersForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = elements.importCustomersFile.files[0];
                const conflictResolution = document.querySelector('input[name="import-conflict-customers"]:checked').value;
                try {
                    await importCustomers(file, conflictResolution);
                    hideModal(elements.importCustomersModal);
                    elements.importCustomersFile.value = '';
                } catch (error) {
                    // Handled by importCustomers function
                }
            });

            // Suppliers
            elements.addSupplierBtn.addEventListener('click', () => openSupplierModal());
            elements.supplierForm.addEventListener('submit', saveSupplier);
            elements.supplierSearch.addEventListener('input', () => {
                pagination.suppliers.currentPage = 1;
                renderSuppliers();
            });
            elements.suppliersPrevPage.addEventListener('click', () => {
                pagination.suppliers.currentPage--;
                renderSuppliers();
            });
            elements.suppliersNextPage.addEventListener('click', () => {
                pagination.suppliers.currentPage++;
                renderSuppliers();
            });
            elements.exportSuppliersBtn.addEventListener('click', exportSuppliers);
            elements.importSuppliersBtn.addEventListener('click', () => {
                showModal(elements.importSuppliersModal);
            });
            elements.importSuppliersForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = elements.importSuppliersFile.files[0];
                const conflictResolution = document.querySelector('input[name="import-conflict-suppliers"]:checked').value;
                try {
                    await importSuppliers(file, conflictResolution);
                    hideModal(elements.importSuppliersModal);
                    elements.importSuppliersFile.value = '';
                } catch (error) {
                    // Handled by importSuppliers function
                }
            });

            // Purchase Orders
            elements.createPoBtn.addEventListener('click', () => openPurchaseOrderModal());
            elements.poForm.addEventListener('submit', savePurchaseOrder);
            elements.poSearch.addEventListener('input', () => {
                pagination.purchaseOrders.currentPage = 1;
                renderPurchaseOrders();
            });
            elements.poStatusFilter.addEventListener('change', () => {
                pagination.purchaseOrders.currentPage = 1;
                renderPurchaseOrders();
            });
            elements.posPrevPage.addEventListener('click', () => {
                pagination.purchaseOrders.currentPage--;
                renderPurchaseOrders();
            });
            elements.posNextPage.addEventListener('click', () => {
                pagination.purchaseOrders.currentPage++;
                renderPurchaseOrders();
            });
            elements.exportPosBtn.addEventListener('click', exportPurchaseOrders);
            elements.poBookSearch.addEventListener('input', (e) => searchBooksForPo(e.target.value));
            elements.poBookSearch.addEventListener('focus', (e) => searchBooksForPo(e.target.value));
            document.addEventListener('click', (e) => {
                if (!elements.poBookSearchResults.contains(e.target) && e.target !== elements.poBookSearch) {
                    elements.poBookSearchResults.innerHTML = '';
                }
            });


            // Cart & Sales
            elements.bookToCartSearch.addEventListener('input', () => {
                pagination.booksForCart.currentPage = 1;
                renderBooksForCart();
            });
            elements.booksForCartPrevPage.addEventListener('click', () => {
                pagination.booksForCart.currentPage--;
                renderBooksForCart();
            });
            elements.booksForCartNextPage.addEventListener('click', () => {
                pagination.booksForCart.currentPage++;
                renderBooksForCart();
            });
            elements.clearCartBtn.addEventListener('click', clearCart);
            elements.checkoutBtn.addEventListener('click', openCheckoutModal);
            elements.applyPromoBtn.addEventListener('click', applyPromotion);
            elements.checkoutForm.addEventListener('submit', completeCheckout);
            elements.viewSalesHistoryBtn.addEventListener('click', () => showPage('sales-history'));
            elements.backToCartBtn.addEventListener('click', () => showPage('cart'));
            elements.saleSearch.addEventListener('input', () => {
                pagination.sales.currentPage = 1;
                renderSalesHistory();
            });
            elements.salesPrevPage.addEventListener('click', () => {
                pagination.sales.currentPage--;
                renderSalesHistory();
            });
            elements.salesNextPage.addEventListener('click', () => {
                pagination.sales.currentPage++;
                renderSalesHistory();
            });
            elements.exportSalesBtn.addEventListener('click', exportSales);
            elements.printReceiptBtn.addEventListener('click', printReceipt);
            elements.downloadReceiptBtn.addEventListener('click', downloadReceiptPdf);

            // Promotions
            elements.addPromotionBtn.addEventListener('click', () => openPromotionModal());
            elements.promotionTypePercentage.addEventListener('click', () => {
                elements.promotionType.value = 'percentage';
                elements.promotionTypePercentage.classList.add('active');
                elements.promotionTypeFixed.classList.remove('active');
            });
            elements.promotionTypeFixed.addEventListener('click', () => {
                elements.promotionType.value = 'fixed';
                elements.promotionTypeFixed.classList.add('active');
                elements.promotionTypePercentage.classList.remove('active');
            });
            elements.promotionAppliesTo.addEventListener('change', () => {
                elements.promotionBookGroup.style.display = 'none';
                elements.promotionCategoryGroup.style.display = 'none';
                if (elements.promotionAppliesTo.value === 'specific-book') {
                    elements.promotionBookGroup.style.display = 'block';
                } else if (elements.promotionAppliesTo.value === 'specific-category') {
                    elements.promotionCategoryGroup.style.display = 'block';
                }
            });
            elements.promotionForm.addEventListener('submit', savePromotion);

            // Expenses
            elements.addExpenseBtn.addEventListener('click', () => openExpenseModal());
            elements.expenseForm.addEventListener('submit', saveExpense);
            elements.expenseSearch.addEventListener('input', () => {
                pagination.expenses.currentPage = 1;
                renderExpenses();
            });
            elements.expenseMonthFilter.addEventListener('change', () => {
                pagination.expenses.currentPage = 1;
                renderExpenses();
            });
            elements.expensesPrevPage.addEventListener('click', () => {
                pagination.expenses.currentPage--;
                renderExpenses();
            });
            elements.expensesNextPage.addEventListener('click', () => {
                pagination.expenses.currentPage++;
                renderExpenses();
            });

            // Reports
            elements.reportType.addEventListener('change', updateReportFilters);
            elements.generateReportBtn.addEventListener('click', generateReport);
            elements.exportCurrentReportBtn.addEventListener('click', exportCurrentReport);

            // Backup & Restore
            elements.exportAllDataBtn.addEventListener('click', exportAllData);
            elements.importFile.addEventListener('change', () => {
                elements.importAllDataBtn.disabled = !elements.importFile.files.length;
            });
            elements.importAllDataBtn.addEventListener('click', importAllDataHandler);

            document.addEventListener('DOMContentLoaded', () => {
                // Initialize pagination button elements
                pagination.books.elements = {
                    prev: elements.booksPrevPage,
                    next: elements.booksNextPage,
                    info: elements.booksPageInfo
                };
                pagination.customers.elements = {
                    prev: elements.customersPrevPage,
                    next: elements.customersNextPage,
                    info: elements.customersPageInfo
                };
                pagination.suppliers.elements = {
                    prev: elements.suppliersPrevPage,
                    next: elements.suppliersNextPage,
                    info: elements.suppliersPageInfo
                };
                pagination.purchaseOrders.elements = {
                    prev: elements.posPrevPage,
                    next: elements.posNextPage,
                    info: elements.posPageInfo
                };
                pagination.booksForCart.elements = {
                    prev: elements.booksForCartPrevPage,
                    next: elements.booksForCartNextPage,
                    info: elements.booksForCartPageInfo
                };
                pagination.sales.elements = {
                    prev: elements.salesPrevPage,
                    next: elements.salesNextPage,
                    info: elements.salesPageInfo
                };
                pagination.expenses.elements = {
                    prev: elements.expensesPrevPage,
                    next: elements.expensesNextPage,
                    info: elements.expensesPageInfo
                };

                initDb().then(() => {
                    const initialPage = window.location.hash ? window.location.hash.substring(1) : 'dashboard';
                    showPage(initialPage);
                }).catch(err => {
                    console.error('Failed to initialize app:', err);
                    showToast('Application failed to load properly. Check console for details.', 'error');
                });
            });
        }

        setupEventListeners();
    </script>
</body>

</html>